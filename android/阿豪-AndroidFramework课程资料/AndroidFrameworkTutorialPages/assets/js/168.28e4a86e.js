(window.webpackJsonp=window.webpackJsonp||[]).push([[168],{588:function(s,a,t){"use strict";t.r(a);var n=t(2),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"_1-开机时间的分析方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-开机时间的分析方法"}},[s._v("#")]),s._v(" 1. 开机时间的分析方法")]),s._v(" "),a("h3",{attrs:{id:"_1-1-通过日志信息获取开机耗时信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-通过日志信息获取开机耗时信息"}},[s._v("#")]),s._v(" 1.1 通过日志信息获取开机耗时信息")]),s._v(" "),a("p",[s._v("Android 系统把 Log 分为了四类，用于记录不同的 Log 信息：")]),s._v(" "),a("ul",[a("li",[s._v("main：应用层 App Log")]),s._v(" "),a("li",[s._v("events：系统事件相关的 Log 信息")]),s._v(" "),a("li",[s._v("radio：无线/电话相关的 Log 信息")]),s._v(" "),a("li",[s._v("system：低级别的系统调试 Log 信息")])]),s._v(" "),a("p",[s._v("默认通过 logcat 抓取的是 main 信息，我们可以通过 -b 选项来指定日志的类别。开机的关键节点日志通过 events 日志记录，我们可以通过如下命令获取到：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("adb logcat "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-b")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"events"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"boot_progress"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:11.541  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1502")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1502")]),s._v(" I boot_progress_start: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4134")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:11.699  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1502")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1502")]),s._v(" I boot_progress_preload_start: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4291")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.025  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1502")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1502")]),s._v(" I boot_progress_preload_end: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4617")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.173  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I boot_progress_system_run: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4765")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.459  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I boot_progress_pms_start: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5052")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.507  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I boot_progress_pms_system_scan_start: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5099")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.751  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I boot_progress_pms_data_scan_start: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5343")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.752  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I boot_progress_pms_scan_end: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5345")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.799  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I boot_progress_pms_ready: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5391")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:13.251  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I boot_progress_ams_ready: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5843")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:13.677  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1695")]),s._v(" I boot_progress_enable_screen: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6269")]),s._v("\n\nadb logcat "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-b")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"events"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sf_stop_bootanim"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:15.260  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1553")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1653")]),s._v(" I sf_stop_bootanim: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7852")]),s._v("\n\nadb logcat "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-b")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"events"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"wm_boot_animation_done"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:15.260  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1695")]),s._v(" I wm_boot_animation_done: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7852")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("每条数据的最后是距离开机时的事件，倒数第二个数据是关键节点的名字：")]),s._v(" "),a("ul",[a("li",[s._v("boot_progress_start：系统进入用户空间，标志着 kernel 启动完成")]),s._v(" "),a("li",[s._v("boot_progress_preload_start：Zygote preload 过程启动")]),s._v(" "),a("li",[s._v("boot_progress_preload_end：Zygote preload 过程结束")]),s._v(" "),a("li",[s._v("boot_progress_system_run：开始启动 Android 系统服务")]),s._v(" "),a("li",[s._v("boot_progress_pms_start：PMS 开始扫描安装的应用")]),s._v(" "),a("li",[s._v("boot_progress_pms_system_scan_start：PMS 先行扫描 /system 目录下的安装包")]),s._v(" "),a("li",[s._v("boot_progress_pms_data_scan_start：PMS 扫描 /data 目录下的安装包")]),s._v(" "),a("li",[s._v("boot_progress_pms_scan_end：PMS 扫描结束")]),s._v(" "),a("li",[s._v("boot_progress_pms_ready：PMS 就绪")]),s._v(" "),a("li",[s._v("boot_progress_ams_ready：AMS 就绪")]),s._v(" "),a("li",[s._v("boot_progress_enable_screen：AMS 启动完成后开始激活屏幕，从此以后屏幕才能响应用户的触摸，它在 WindowManagerService 发出退出开机动画的时间节点之前")]),s._v(" "),a("li",[s._v("sf_stop_bootanim：surfaceflinger 设置 service.bootanim.exit 属性值为 1，标志系统要结束开机动画了")]),s._v(" "),a("li",[s._v("wm_boot_animation_done：开机动画结束，这一步用户能直观感受到开机结束")])]),s._v(" "),a("p",[s._v("补充说明下开机动画关闭的时机：")]),s._v(" "),a("p",[s._v("Launcher 启动完之后，我们还看不到 Launcher，因为被 BootAnimation 的画面挡住了。BootAnimation　的退出也比较复杂，大概是第一个 Launcher 起来之后，其 ActivityThread 线程进入空闲状态时(使用 IdleHandler)，把 BootAnimation 给退出。这样就能确保在 BootAnimation 退出后，用户看到的不是黑屏，而是我们的桌面了。")]),s._v(" "),a("p",[s._v("这些时间通常使用 excel 或者 wps 表格制作成折线图更为直观：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/stingerzou/MyImages//20231225215856.png",alt:""}})]),s._v(" "),a("p",[s._v("以上特定日志的分析，粒度较大，只能定位出大概的耗时流程，之后还需分析流程内部具体的耗时情况。开机各流程内部也有相应的日志，可以进行更加细致的分析。例如在 SystemServiceManager 类中启动服务时，会打印启动某项服务的日志。通过查看某个服务 A 与下一个服务的日志时间，可以计算出启动服务A的耗时。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("adb logcat "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"SystemService"')]),s._v("          \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.276  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I SystemServiceManager: Starting com.android.server.pm.Installer\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.278  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I SystemServiceManager: Starting com.android.server.os.DeviceIdentifiersPolicyService\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.278  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I SystemServiceManager: Starting com.android.server.uri.UriGrantsManagerService"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$Lifecycle")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.280  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I SystemServiceManager: Starting com.android.server.wm.ActivityTaskManagerService"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$Lifecycle")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.282  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I SystemServiceManager: Starting com.android.server.am.ActivityManagerService"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$Lifecycle")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.339  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I SystemServiceManager: Starting com.android.server.power.PowerManagerService\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.347  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I SystemServiceManager: Starting com.android.server.power.ThermalManagerService\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.347  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I SystemServer: StartRecoverySystemService\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.348  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I SystemServiceManager: Starting com.android.server.RecoverySystemService\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.348  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" D SystemServerTiming: StartRecoverySystemService took to complete: 0ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.348  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I SystemServiceManager: Starting com.android.server.lights.LightsService\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("-23 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":03:12.450  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v(" I SystemServiceManager: Starting com.android.server.display.DisplayManagerService\nKeyChainSystemService\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ......")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("h3",{attrs:{id:"_1-2-使用-bootchart-分析开机启动时间"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-使用-bootchart-分析开机启动时间"}},[s._v("#")]),s._v(" 1.2 使用 bootchart 分析开机启动时间")]),s._v(" "),a("p",[s._v("bootchart 是一个能对 GNU/Linux boot 过程进行性能分析并把结果直观化的开源工具，在系统启动过程中自动收集 CPU 占用率、磁盘吞吐率、进程等信息，并以图形方式显示分析结果，可用作指导优化系统启动过程。BootChart 包含数据收集工具和图像产生工具，数据收集工具在原始的 BootChart 中是独立的 shell 程序，但在 Android 中，数据收集工具被集成到了 init 程序中。")]),s._v(" "),a("p",[s._v("在 Android 中会通过一个叫 "),a("code",[s._v("do_bootchart_start")]),s._v(" 的函数来判断是否抓取 bootchar 数据")]),s._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// system/core/init/bootchart.cpp")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" Result"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Success"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("do_bootchart_start")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// We don't care about the content, but we do care that /data/bootchart/enabled actually exists.")]),s._v("\n    std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[s._v("::")]),s._v("string start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 只要存在/data/bootchart/enabled文件，即抓取 bootchart 数据")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("android"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[s._v("::")]),s._v("base"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[s._v("::")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ReadFileToString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/data/bootchart/enabled"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("LOG")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("VERBOSE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Not bootcharting"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Success")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    g_bootcharting_thread "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[s._v("::")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bootchart_thread_main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Success")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("所以我们只要创建一个 "),a("code",[s._v("/data/bootchart/enabled")]),s._v(" 即可开启 bootchar 数据的抓取。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("adb shell "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" /data/bootchart/enabled\nadb "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("reboot")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("接着我们准备用于生成 bootchart 图的分析软件 pybootchartgui：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载 pybootchartgui")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" python-is-python3\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" ~/Documents\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/xrmx/bootchart.git\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" bootchart/pybootchartgui\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" main.py.in main.py\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 建立")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" ~/Documents/bootchart/pybootchartgui.py /usr/bin/pybootchartgui\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("回到 Android 源码目录下执行：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("system/core/init/grab-bootchart.sh\n\nparsing "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/tmp/android-bootchart/bootchart.tgz'")]),s._v("\nparsing "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'header'")]),s._v("\nparsing "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'proc_stat.log'")]),s._v("\nparsing "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'proc_ps.log'")]),s._v("\nparsing "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'proc_diskstats.log'")]),s._v("\nmerged "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" logger processes\npruned "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("47")]),s._v(" process, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" exploders, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" threads, and "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" runs\nbootchart written to "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'bootchart.png'")]),s._v("\nClean up /tmp/android-bootchart/ and ./bootchart.png when "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("在源码目录下就生成了 "),a("code",[s._v("bootchart.png")]),s._v(" 图：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/stingerzou/MyImages//bootchart.png",alt:""}})]),s._v(" "),a("p",[s._v("从生成的图片可以更加直观详细的看到开机耗时以及硬件使用情况.")]),s._v(" "),a("h3",{attrs:{id:"_1-3-抓取-trace-文件分析开机启动时间"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-抓取-trace-文件分析开机启动时间"}},[s._v("#")]),s._v(" 1.3 抓取 trace 文件分析开机启动时间")]),s._v(" "),a("p",[s._v("修改 "),a("code",[s._v("frameworks/native/cmds/atrace/atrace.rc")]),s._v(" 中 "),a("code",[s._v("service boottrace")]),s._v(" 的内容：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" boottrace /system/bin/atrace "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--async_start")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-b")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30720")]),s._v(" gfx input view webview wm am sm audio video binder_lock binder_driver camera hal res dalvik rs bionic power pm ss database network adb vibrator aidl sched  \n    disabled\n    oneshot\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("接着重新编译源码，启动虚拟机。")]),s._v(" "),a("p",[s._v("打开抓取 boottrace 的属性开关")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("adb  shell setprop persist.debug.atrace.boottrace "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("手机启动完成之后等待几秒，关闭 boottrace 属性开关")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("adb  shell setprop persist.debug.atrace.boottrace "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("生成和拉取 boottrace 文件")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("adb shell atrace "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--async_stop")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-z")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" /data/local/tmp/boot_trace\nadb  pull /data/local/tmp/boot_trace\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("自此，我们就得到了启动阶段的 trace 文件，可以通过 perfetto 工具打开并分析它了。")]),s._v(" "),a("h2",{attrs:{id:"_2-开机启动优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-开机启动优化"}},[s._v("#")]),s._v(" 2. 开机启动优化")]),s._v(" "),a("p",[s._v("开启启动优化可以分为两类：")]),s._v(" "),a("ul",[a("li",[s._v("程序异常，导致开机时间加长或无法开机")]),s._v(" "),a("li",[s._v("正常开机时间的基础上加快开机速度")])]),s._v(" "),a("p",[s._v("第一种情况，很多时候是某个模块的魔改导致的，我们的主要任务是找到这个模块，一般通过上一节介绍的三种开机时间分析的手段就可以很容易的找到了。")]),s._v(" "),a("p",[s._v("更多的时候是第二种情况，Android 启动可以优化的阶段主要有：")]),s._v(" "),a("ul",[a("li",[s._v("Bootloader")]),s._v(" "),a("li",[s._v("Kernel")]),s._v(" "),a("li",[s._v("Framework")])]),s._v(" "),a("p",[s._v("我们主要关注 Framework 阶段的优化，常见的优化手段有：")]),s._v(" "),a("p",[a("strong",[s._v("在 Zygote 进程启动后，加载自定义的驱动，启动自定义的进程")])]),s._v(" "),a("p",[s._v("zygote 是在 late-init 阶段启动")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("on late-init\n    trigger early-fs\n    trigger fs\n    trigger post-fs\n    trigger late-fs\n    trigger post-fs-data\n    trigger load_persist_props_action\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# zygote 启动")]),s._v("\n    trigger zygote-start\n    trigger firmware_mounts_complete\n    trigger early-boot\n    trigger boot\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("加载自定义的驱动，启动自定义的进程两类操作，我们可以放到  early-boot 或者 boot 阶段启动，这样可以让 Zygote 进程尽早的启动，加快系统的启动。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("on boot\n    insmod /vendor/lib/modules/btusb.ko\n    start xxxx\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# .....")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("strong",[s._v("调整 Zygote 启动参数")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" zygote /system/bin/app_process "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-Xzygote")]),s._v(" /system/bin "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--zygote")]),s._v(" --start-system-server --enable-lazy-preload\n    class main\n    priority "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-20")]),s._v("\n    user root\n    group root readproc reserved_disk\n    socket zygote stream "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("660")]),s._v(" root system\n    socket usap_pool_primary stream "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("660")]),s._v(" root system\n    onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse\n    onrestart "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /sys/power/state on\n    onrestart restart audioserver\n    onrestart restart cameraserver\n    onrestart restart media\n    onrestart restart netd\n    onrestart restart wificond\n    task_profiles ProcessCapacityHigh MaxPerformance\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("这里改动了两个地方 "),a("code",[s._v("--enable-lazy-preload")]),s._v("，"),a("code",[s._v("task_profiles ProcessCapacityHigh MaxPerformance")]),s._v("。")]),s._v(" "),a("p",[s._v("添加了 "),a("code",[s._v("--enable-lazy-preload")]),s._v(" 参数，在开机阶段不会执行 "),a("code",[s._v("preload")]),s._v(" 预加载操作。在开机后，通过 system-server 发送指令给 zygote 做资源加载操作，在发送指令前，system-server 会加载一部分自己使用的类，会和 zygote 中存在相同的一部分备份，所有会多耗费一些内存。")]),s._v(" "),a("p",[a("code",[s._v("task_profiles ProcessCapacityHigh MaxPerformance")]),s._v(" 会让内核使用尽可能多的资源来启动 Zygote。")]),s._v(" "),a("p",[a("strong",[s._v("开机阶段 CPU 开启性能模式")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cpu 开启性能模式")]),s._v("\non early-init\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开机完成后，CPU 频率变成自适应")]),s._v("\non property:sys.boot_completed"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[a("strong",[s._v("读写 IO 调整")])]),s._v(" "),a("p",[s._v("可以通过调整事先预读数据的 Kb 数以及默认 IO 请求队列的长度来加快 IO 的读写以提高开机速度")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# on late-fs")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     # boot time fs tune")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     write /sys/block/mmcblk0/queue/iostats 0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     # 增大事先预读数据的 Kb 数")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     write /sys/block/mmcblk0/queue/read_ahead_kb 2048")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     # 默认 IO 请求队列的长度")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     write /sys/block/mmcblk0/queue/nr_requests 256")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# on property:sys.boot_completed=1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     # end boot time fs tune")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     write /sys/block/mmcblk0/queue/read_ahead_kb 128")]),s._v("\n\non late-fs\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# boot time fs tune")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /sys/block/sda/queue/iostats "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /sys/block/sda/queue/scheduler cfq\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /sys/block/sda/queue/iosched/slice_idle "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 增大事先预读数据的 Kb 数")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /sys/block/sda/queue/read_ahead_kb "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# IO 请求队列的长度")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /sys/block/sda/queue/nr_requests "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /sys/block/dm-0/queue/read_ahead_kb "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /sys/block/dm-1/queue/read_ahead_kb "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v("\n\non property:sys.boot_completed"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# end boot time fs tune")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /sys/block/sda/queue/read_ahead_kb "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("512")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("p",[a("strong",[s._v("移除没有用的模块")])]),s._v(" "),a("p",[s._v("主要是修改 SystemServer，删除一些用不到的服务,比如有的产品是电视、音响，就不会用到电话，指纹、定位、打印等相关的模块。")]),s._v(" "),a("p",[s._v("一般可裁剪的模块有：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("TelecomLoaderService\nTelephonyRegistry\nStatusBarManagerService\nSearchManagerService\nSerialService\nFingerprintService\nCameraService\nMmsService\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[a("strong",[s._v("延时启动 persist app")])]),s._v(" "),a("p",[s._v("修改 "),a("code",[s._v("startPersistentApps")]),s._v(" 方法，延时启动 persist app")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("startPersistentApps")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" matchFlags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mFactoryTest "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FactoryTest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("FACTORY_TEST_LOW_LEVEL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("List")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ApplicationInfo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" apps "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AppGlobals")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getPackageManager")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getPersistentApplications")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("STOCK_PM_FLAGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" matchFlags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getList")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ApplicationInfo")]),s._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" apps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"android"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("equals")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("packageName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    mHandler"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("postDelayed")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("addAppLocked")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* ABI override */")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ZYGOTE_POLICY_FLAG_BATCH_LAUNCH")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RemoteException")]),s._v(" ex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[a("strong",[s._v("精简 preload 的 classes")])]),s._v(" "),a("p",[s._v("可以根据产品的类型修改 "),a("code",[s._v("frameworks/base/config/preloaded-classes")]),s._v(" 文件，来删减一些用不到的 preload classes")]),s._v(" "),a("p",[s._v("常见可删除的预加载 classes 有：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("// 生物识别\nandroid.hardware.biometrics\n\n// 人脸识别\nandroid.hardware.face\n\n// 打印服务\nandroid.hardware.fingerprint\nandroid.print.\n\n// 部分定位相关, 还有GPS定位相关\nandroid.hardware.location\ncom.android.internal.location.GpsNetInitiatedHandler\nandroid.location.Gnss*\n\n// 手机通话相关\nandroid.telephony.\nandroid.telecom.\ncom.android.i18n.phonenumbers.\ncom.android.ims\nandroid.hardware.radio\n\n// nfc相关\nandroid.nfc.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[s._v("如果需要再做一些大的裁剪，可以使用 "),a("code",[s._v("frameworks\\base\\config\\generate-preloaded-classes.sh")]),s._v(" 脚本来重新生成 preloaded-classes")]),s._v(" "),a("h2",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.jianshu.com/p/3f23e027b591",target:"_blank",rel:"noopener noreferrer"}},[s._v("Android开机全解析"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://0uyangsheng.github.io/2018/05/14/Android%20boot%20optimization/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Android开机启动优化"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://source.android.com/docs/core/perf/boot-times?hl=zh-cn",target:"_blank",rel:"noopener noreferrer"}},[s._v("优化启动时间"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://blog.csdn.net/he980725866/article/details/123030906",target:"_blank",rel:"noopener noreferrer"}},[s._v("Android TV开机优化"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=e.exports}}]);