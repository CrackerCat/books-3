<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Android AMS 完全剖析 —— Activity 管理之启动过程情景分析7 | Android Framework</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/AndroidFrameworkTutorialPages/assets/css/0.styles.ec7aed17.css" as="style"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/app.6bee58ca.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/7.4046385e.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/2.b8949bfe.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/1.1165d272.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/207.6a0fb53c.js" as="script"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/10.337b766a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/100.72736f69.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/101.5f94d145.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/102.d46507a2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/103.62bc736d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/104.094e7d39.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/105.8649bab5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/106.f4471270.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/107.a4d0d98b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/108.fa147bd9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/109.adf77d95.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/11.be2e0167.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/110.94967d09.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/111.e03020fe.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/112.4873c818.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/113.03968f51.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/114.b3acbb7e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/115.7d741a08.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/116.bed9a972.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/117.5fa3c703.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/118.1cb82fbd.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/119.1e42a517.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/120.5cab3fee.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/121.5ebf516c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/122.9fa61bb5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/123.68670591.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/124.e20797c4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/125.afb2f74f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/126.5ee1833a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/127.99b668fe.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/128.31cc5a62.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/129.c4c6f153.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/130.244b0cdc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/131.b04bca8c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/132.26b04438.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/133.6d4105f9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/134.3caa2583.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/135.f16ec1d8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/136.bce7a620.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/137.89783106.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/138.844df1ed.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/139.9bd06dde.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/14.7d944ea8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/140.47e0612e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/141.bcb89b7d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/142.fa77e5f5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/143.2133b57d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/144.1c5718b3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/145.6b778a66.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/146.65d0ba21.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/147.cc848d93.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/148.0d48f820.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/149.1bfabe32.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/15.bf19b574.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/150.d226e17b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/151.683cee30.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/152.1e08bc9f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/153.7b036048.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/154.f4427860.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/155.97b58f86.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/156.6253030d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/157.c4b2705a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/158.e56ee3bf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/159.8bdf5bf9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/16.91ebb564.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/160.31a5c38a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/161.442baa69.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/162.ace1371b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/163.c045adf7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/164.130ddeb6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/165.ba5e3166.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/166.05cbc08a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/167.d3af2d93.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/168.28e4a86e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/169.b5534740.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/17.bfe50ee3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/170.b9f8ce6c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/171.2e5062ac.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/172.d41cb3be.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/173.7fd57dd2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/174.c5711ef1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/175.35e58f60.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/176.5c3a823b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/177.9f0c01b8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/178.db5f56e3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/179.3cba5445.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/18.05ccfb53.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/180.9421ca90.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/181.d2432935.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/182.ad8fe591.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/183.ef903b97.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/184.7e7614df.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/185.247ca305.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/186.1c9d067f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/187.8b4406b3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/188.54e1c445.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/189.611a92d3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/19.afa41ba1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/190.34f0b0ac.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/191.bf8f6578.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/192.0a98e607.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/193.fcd95338.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/194.e896bffb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/195.994ef040.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/196.107f6daf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/197.2eace9c7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/198.8f28f24e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/199.896f5c51.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/20.e9510ad7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/200.20e5fa81.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/201.1f836eb2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/202.3c04816c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/203.f1654ace.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/204.32e15ed6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/205.18d27ec0.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/206.952ebb9b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/208.10771e83.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/209.d113ff5b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/21.86ad6466.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/210.ca14ba8f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/211.949c32ac.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/212.0dfb85d8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/213.9b8200d8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/214.3e51b142.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/215.cdd786a4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/216.c8e67636.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/217.687d3ea6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/218.f37711a3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/219.e12c93a8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/22.09086018.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/220.89e4ec6e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/221.02367691.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/222.e5db60ae.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/223.151e46b9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/224.3c5c08e9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/225.a10a3689.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/226.dc6cf592.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/227.5d484f21.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/228.32831b10.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/229.263fbcc1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/23.62e146ab.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/230.7e5f6ff9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/24.36df6bff.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/25.99201ee4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/26.0dad3cd4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/27.be36597a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/28.4a19ff25.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/29.5c2b113e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/3.97bbbdc8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/30.38a9b8bb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/31.0d5a08c3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/32.804ecc25.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/33.a8e71e21.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/34.da185bf8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/35.e45072d9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/36.b81c8de2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/37.f26d2d52.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/38.3d72fa2e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/39.8de59f74.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/4.983d15c3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/40.9a73323f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/41.42900ccd.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/42.10a23b66.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/43.4f3cf1ea.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/44.8dc2b0d6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/45.76ee68b3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/46.24ca3ec6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/47.ce306e3f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/48.594e18b2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/49.1ac45e0a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/5.574f6fbb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/50.5cf1e47d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/51.037e5442.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/52.141d9248.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/53.6b1fbef2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/54.e55084df.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/55.9e651b61.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/56.ac520841.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/57.63b15773.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/58.feb843a2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/59.9d66b37d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/6.a4122f72.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/60.a8c87ab2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/61.5f078d82.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/62.3a0f4d59.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/63.8c484ea1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/64.cc875fce.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/65.82180ec7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/66.2eb988a8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/67.8308704f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/68.746ae2c4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/69.d429f413.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/70.0f287cf2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/71.e5e79631.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/72.caa5fa2e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/73.8eee8534.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/74.442758f4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/75.039e0439.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/76.a8b36acd.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/77.fe077be8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/78.c7b893c0.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/79.2593cbe8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/8.9d6eb8a6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/80.d01aa2ae.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/81.c35e3eaf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/82.7438991c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/83.72e120f5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/84.d4092596.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/85.7bd957ce.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/86.68aca8a4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/87.34fa1f22.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/88.2c8a64b8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/89.02b77ecc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/9.bee9eff5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/90.58a2ef63.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/91.04b48f98.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/92.b0369a2d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/93.8b05fefe.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/94.97bbf0f3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/95.57a85eaf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/96.df8ce9d8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/97.f39c40ea.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/98.2d6a15af.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/99.d3f9e663.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/vendors~docsearch.833ce4c0.js">
    <link rel="stylesheet" href="/AndroidFrameworkTutorialPages/assets/css/0.styles.ec7aed17.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Android Framework</h3> <p class="description" data-v-59e6cb88></p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/AndroidFrameworkTutorialPages/" class="home-link router-link-active"><!----> <span class="site-name">Android Framework</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>177</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <!----> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>学习路线与指南</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AndroidFrameworkTutorialPages/000. 学习路线与指南/Android Framework 学习路线.html" class="sidebar-link">Android Framework 学习路线</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>玩转AOSP篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>学穿Binder篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础组件篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统启动篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>应用层框架篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Hal 与硬件服务篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>图形系统篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>输入系统篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统应用篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>构造系统篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目实战</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Android AMS 完全剖析 —— Activity 管理之启动过程情景分析7</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page" style="padding-right:0;"><section style="display:;"><div class="page-title"><h1 class="title">Android AMS 完全剖析 —— Activity 管理之启动过程情景分析7</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>阿豪</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>1/22/2024</span></i> <i class="iconfont reco-eye" data-v-8a445198><span id="/AndroidFrameworkTutorialPages/006.%E5%BA%94%E7%94%A8%E5%B1%82%E6%A1%86%E6%9E%B6/Android%20AMS%20%E5%AE%8C%E5%85%A8%E5%89%96%E6%9E%90%20%E2%80%94%E2%80%94%20Activity%20%E7%AE%A1%E7%90%86%E4%B9%8B%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%83%85%E6%99%AF%E5%88%86%E6%9E%907.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <!----></div></div> <div class="theme-reco-content content__default"><p>接下来就会执行到 ActivityThread 类的 main 方法了：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;ActivityThreadMain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Install selective syscall interception</span>
        <span class="token class-name">AndroidOs</span><span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// CloseGuard defaults to true and can be quite spammy.  We</span>
        <span class="token comment">// disable it here, but selectively enable it later (via</span>
        <span class="token comment">// StrictMode) on debug builds, but using DropBox, not logs.</span>
        <span class="token class-name">CloseGuard</span><span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Environment</span><span class="token punctuation">.</span><span class="token function">initForCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span>
        <span class="token keyword">final</span> <span class="token class-name">File</span> configDir <span class="token operator">=</span> <span class="token class-name">Environment</span><span class="token punctuation">.</span><span class="token function">getUserConfigDirectory</span><span class="token punctuation">(</span><span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TrustedCertificateStore</span><span class="token punctuation">.</span><span class="token function">setDefaultUserDirectory</span><span class="token punctuation">(</span>configDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">setArgV0</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;pre-initialized&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 主线程 Looper</span>
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Find the value for {@link #PROC_START_SEQ_IDENT} if provided on the command line.</span>
        <span class="token comment">// It will be in the format &quot;seq=114&quot;</span>
        <span class="token keyword">long</span> startSeq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> args<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">PROC_START_SEQ_IDENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    startSeq <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>
                            args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token constant">PROC_START_SEQ_IDENT</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// </span>
        <span class="token class-name">ActivityThread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// attach 到系统进程</span>
        thread<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sMainThreadHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sMainThreadHandler <span class="token operator">=</span> thread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessageLogging</span><span class="token punctuation">(</span><span class="token keyword">new</span>
                    <span class="token class-name">LogPrinter</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">DEBUG</span><span class="token punctuation">,</span> <span class="token string">&quot;ActivityThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// End of event ActivityThreadMain.</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// loop</span>
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Main thread loop unexpectedly exited&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>主要关注三个点：</p> <ul><li>ActivityThread 的 main 方法就是我们 App 开发中常说的 UI 线程，主线程</li> <li>主线程里面开启了 Looper</li> <li>调用 attach，向 SystemServer 发起一个绑定操作，告诉 AMS 进程应启动完毕，可以进行其他事情了</li></ul> <p>这里的核心关键是 attach 方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> system<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sCurrentActivityThread <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        mSystemThread <span class="token operator">=</span> system<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>system<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 走这个分支</span>

            <span class="token comment">// 设置进程名。此时，还没有ApplicationInfo，所以用&lt;pre-initialized&gt;来命名应用进程</span>
            <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>ddm<span class="token punctuation">.</span></span>DdmHandleAppName</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;pre-initialized&gt;&quot;</span><span class="token punctuation">,</span>
                                                    <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// RunmtimeInit 内部成员初始化                                       </span>
            <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">setApplicationObject</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//拿到 AMS 代理端 </span>
            <span class="token keyword">final</span> <span class="token class-name">IActivityManager</span> mgr <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 通过 Binder 远程调用 AMS 的 attachApplication 方法</span>
                mgr<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Watch for getting close to heap limit.</span>
            <span class="token class-name">BinderInternal</span><span class="token punctuation">.</span><span class="token function">addGcWatcher</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSomeActivitiesChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">Runtime</span> runtime <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">long</span> dalvikMax <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">maxMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">long</span> dalvikUsed <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">totalMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> runtime<span class="token punctuation">.</span><span class="token function">freeMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dalvikUsed <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>dalvikMax<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_MEMORY_TRIM</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Dalvik max=&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dalvikMax<span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">&quot; total=&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">totalMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">&quot; used=&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dalvikUsed<span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mSomeActivitiesChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ActivityTaskManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">releaseSomeActivities</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 系统进程走这里，不用管</span>
            <span class="token comment">// ......</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ViewRootImpl<span class="token punctuation">.</span>ConfigChangedCallback</span> configChangedCallback
                <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Configuration</span> globalConfig<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// We need to apply this change to the resources immediately, because upon returning</span>
                <span class="token comment">// the view hierarchy will be informed about it.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">.</span><span class="token function">applyConfigurationToResourcesLocked</span><span class="token punctuation">(</span>globalConfig<span class="token punctuation">,</span>
                        <span class="token keyword">null</span> <span class="token comment">/* compat */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">updateLocaleListFromAppContext</span><span class="token punctuation">(</span>mInitialApplication<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            mResourcesManager<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocales</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// This actually changed the resources! Tell everyone about it.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingConfiguration <span class="token operator">==</span> <span class="token keyword">null</span>
                            <span class="token operator">||</span> mPendingConfiguration<span class="token punctuation">.</span><span class="token function">isOtherSeqNewer</span><span class="token punctuation">(</span>globalConfig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mPendingConfiguration <span class="token operator">=</span> globalConfig<span class="token punctuation">;</span>
                        <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">.</span><span class="token constant">CONFIGURATION_CHANGED</span><span class="token punctuation">,</span> globalConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 为 ViewRootImpl 注册 Config 回调接口</span>
        <span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span><span class="token function">addConfigCallback</span><span class="token punctuation">(</span>configChangedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><p>核心两点：</p> <ul><li>拿到 AMS 代理端</li> <li>远程调用 AMS 的 attachApplication 方法</li></ul> <p>接下来会远程调用到 AMS 的 attachApplication 方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// /frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> thread<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid application interface&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> callingPid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>进一步调用 attachApplicationLocked：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IApplicationThread</span> thread<span class="token punctuation">,</span>
            <span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// Find the application record that is being attached...  either via</span>
        <span class="token comment">// the pid if we are running in multiple processes, or just pull the</span>
        <span class="token comment">// next app record if we are emulating process with anonymous threads.</span>
        <span class="token class-name">ProcessRecord</span> app<span class="token punctuation">;</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> bindApplicationTimeMillis<span class="token punctuation">;</span>


        <span class="token comment">// 根据 PID 映射应用进程的 ProcessRecord 对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token constant">MY_PID</span> <span class="token operator">&amp;&amp;</span> pid <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPidsSelfLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                app <span class="token operator">=</span> mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>startUid <span class="token operator">!=</span> callingUid <span class="token operator">||</span> app<span class="token punctuation">.</span>startSeq <span class="token operator">!=</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//不进入</span>
                <span class="token class-name">String</span> processName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">ProcessRecord</span> pending <span class="token operator">=</span> mProcessList<span class="token punctuation">.</span>mPendingStarts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    processName <span class="token operator">=</span> pending<span class="token punctuation">.</span>processName<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;attachApplicationLocked process:&quot;</span> <span class="token operator">+</span> processName
                        <span class="token operator">+</span> <span class="token string">&quot; startSeq:&quot;</span> <span class="token operator">+</span> startSeq
                        <span class="token operator">+</span> <span class="token string">&quot; pid:&quot;</span> <span class="token operator">+</span> pid
                        <span class="token operator">+</span> <span class="token string">&quot; belongs to another existing app:&quot;</span> <span class="token operator">+</span> app<span class="token punctuation">.</span>processName
                        <span class="token operator">+</span> <span class="token string">&quot; startSeq:&quot;</span> <span class="token operator">+</span> app<span class="token punctuation">.</span>startSeq<span class="token punctuation">;</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// SafetyNet logging for b/131105245.</span>
                <span class="token class-name">EventLog</span><span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span><span class="token number">0x534e4554</span><span class="token punctuation">,</span> <span class="token string">&quot;131105245&quot;</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>startUid<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// If there is already an app occupying that pid that hasn't been cleaned up</span>
                <span class="token function">cleanUpApplicationRecordLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                            <span class="token boolean">true</span> <span class="token comment">/*replacingPid*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                app <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            app <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// It's possible that process called attachApplication before we got a chance to</span>
        <span class="token comment">// update the internal state.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> startSeq <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 不进入</span>
            <span class="token keyword">final</span> <span class="token class-name">ProcessRecord</span> pending <span class="token operator">=</span> mProcessList<span class="token punctuation">.</span>mPendingStarts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> pending<span class="token punctuation">.</span>startUid <span class="token operator">==</span> callingUid <span class="token operator">&amp;&amp;</span> pending<span class="token punctuation">.</span>startSeq <span class="token operator">==</span> startSeq
                    <span class="token operator">&amp;&amp;</span> mProcessList<span class="token punctuation">.</span><span class="token function">handleProcessStartedLocked</span><span class="token punctuation">(</span>pending<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> pending
                            <span class="token punctuation">.</span><span class="token function">isUsingWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            startSeq<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                app <span class="token operator">=</span> pending<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 不进入</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;No pending application record for pid &quot;</span> <span class="token operator">+</span> pid
                    <span class="token operator">+</span> <span class="token string">&quot; (IApplicationThread &quot;</span> <span class="token operator">+</span> thread <span class="token operator">+</span> <span class="token string">&quot;); dropping process&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">EventLog</span><span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span><span class="token constant">AM_DROP_PROCESS</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pid <span class="token operator">!=</span> <span class="token constant">MY_PID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">killProcessQuiet</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//TODO: killProcessGroup(app.info.uid, pid);</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    thread<span class="token punctuation">.</span><span class="token function">scheduleExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Ignore exceptions.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If this application record is still attached to a previous</span>
        <span class="token comment">// process, clean it up now.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//不进入</span>
            <span class="token function">handleAppDiedLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Tell the process all about itself.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_ALL</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>
                <span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Binding process pid &quot;</span> <span class="token operator">+</span> pid <span class="token operator">+</span> <span class="token string">&quot; to record &quot;</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">String</span> processName <span class="token operator">=</span> app<span class="token punctuation">.</span>processName<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 注册死亡通知</span>
            <span class="token class-name">AppDeathRecipient</span> adr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppDeathRecipient</span><span class="token punctuation">(</span>
                    app<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">linkToDeath</span><span class="token punctuation">(</span>adr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span>deathRecipient <span class="token operator">=</span> adr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            app<span class="token punctuation">.</span><span class="token function">resetPackageList</span><span class="token punctuation">(</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mProcessList<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">HostingRecord</span><span class="token punctuation">(</span><span class="token string">&quot;link fail&quot;</span><span class="token punctuation">,</span> processName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">EventLog</span><span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span><span class="token constant">AM_PROC_BOUND</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> app<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 对 ProcessRecord app 进行初始化</span>
        app<span class="token punctuation">.</span>curAdj <span class="token operator">=</span> app<span class="token punctuation">.</span>setAdj <span class="token operator">=</span> app<span class="token punctuation">.</span>verifiedAdj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">INVALID_ADJ</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">setCurrentSchedulingGroup</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>setSchedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>forcingToImportant <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token function">updateProcessForegroundLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>hasShownUi <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">setDebugging</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>cached <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>killedByAm <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>killed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>


        <span class="token comment">// We carefully use the same state that PackageManager uses for</span>
        <span class="token comment">// filtering, since we use this flag to decide if we need to install</span>
        <span class="token comment">// providers when user is unlocked later</span>
        app<span class="token punctuation">.</span>unlocked <span class="token operator">=</span> <span class="token class-name">StorageManager</span><span class="token punctuation">.</span><span class="token function">isUserKeyUnlocked</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//移除进程启动超时消息，就是前面 ANR 的埋雷机制</span>
        mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span><span class="token constant">PROC_START_TIMEOUT_MSG</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> normalMode <span class="token operator">=</span> mProcessesReady <span class="token operator">||</span> <span class="token function">isAllowedWhileBooting</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 获取应用进程的所有 Provider</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProviderInfo</span><span class="token punctuation">&gt;</span></span> providers <span class="token operator">=</span> normalMode <span class="token operator">?</span> <span class="token function">generateApplicationProvidersLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">//这又是一个 ANR 埋雷，后续在 ContentProvider 发布的时候会进行解除</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>providers <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">checkAppInLaunchingProvidersLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//不进入</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span><span class="token constant">CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> app<span class="token punctuation">;</span>
            mHandler<span class="token punctuation">.</span><span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token constant">CONTENT_PROVIDER_PUBLISH_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">&quot;attachApplicationLocked: before bindApplication&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>normalMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Launching preboot mode app: &quot;</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_ALL</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>
            <span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;New app record &quot;</span> <span class="token operator">+</span> app
            <span class="token operator">+</span> <span class="token string">&quot; thread=&quot;</span> <span class="token operator">+</span> thread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; pid=&quot;</span> <span class="token operator">+</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">BackupRecord</span> backupTarget <span class="token operator">=</span> mBackupTargets<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> testMode <span class="token operator">=</span> <span class="token class-name">ApplicationThreadConstants</span><span class="token punctuation">.</span><span class="token constant">DEBUG_OFF</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mDebugApp <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mDebugApp<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 不进入</span>
                testMode <span class="token operator">=</span> mWaitForDebugger
                    <span class="token operator">?</span> <span class="token class-name">ApplicationThreadConstants</span><span class="token punctuation">.</span><span class="token constant">DEBUG_WAIT</span>
                    <span class="token operator">:</span> <span class="token class-name">ApplicationThreadConstants</span><span class="token punctuation">.</span><span class="token constant">DEBUG_ON</span><span class="token punctuation">;</span>
                app<span class="token punctuation">.</span><span class="token function">setDebugging</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mDebugTransient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mDebugApp <span class="token operator">=</span> mOrigDebugApp<span class="token punctuation">;</span>
                    mWaitForDebugger <span class="token operator">=</span> mOrigWaitForDebugger<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">boolean</span> enableTrackAllocation <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mTrackAllocationApp <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mTrackAllocationApp<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 不进入</span>
                enableTrackAllocation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                mTrackAllocationApp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// If the app is being launched for restore or full backup, set it up specially</span>
            <span class="token keyword">boolean</span> isRestrictedBackupMode <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>backupTarget <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> backupTarget<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//不进入</span>
                isRestrictedBackupMode <span class="token operator">=</span> backupTarget<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>uid <span class="token operator">&gt;=</span> <span class="token constant">FIRST_APPLICATION_UID</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>backupTarget<span class="token punctuation">.</span>backupMode <span class="token operator">==</span> <span class="token class-name">BackupRecord</span><span class="token punctuation">.</span><span class="token constant">RESTORE</span><span class="token punctuation">)</span>
                                <span class="token operator">||</span> <span class="token punctuation">(</span>backupTarget<span class="token punctuation">.</span>backupMode <span class="token operator">==</span> <span class="token class-name">BackupRecord</span><span class="token punctuation">.</span><span class="token constant">RESTORE_FULL</span><span class="token punctuation">)</span>
                                <span class="token operator">||</span> <span class="token punctuation">(</span>backupTarget<span class="token punctuation">.</span>backupMode <span class="token operator">==</span> <span class="token class-name">BackupRecord</span><span class="token punctuation">.</span><span class="token constant">BACKUP_FULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> <span class="token class-name">ActiveInstrumentation</span> instr <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">getActiveInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>instr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//不进入</span>
                <span class="token function">notifyPackageUse</span><span class="token punctuation">(</span>instr<span class="token punctuation">.</span>mClass<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 <span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">NOTIFY_PACKAGE_USE_INSTRUMENTATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_CONFIGURATION</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_CONFIGURATION</span><span class="token punctuation">,</span> <span class="token string">&quot;Binding proc &quot;</span>
                    <span class="token operator">+</span> processName <span class="token operator">+</span> <span class="token string">&quot; with config &quot;</span>
                    <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ApplicationInfo</span> appInfo <span class="token operator">=</span> instr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> instr<span class="token punctuation">.</span>mTargetInfo <span class="token operator">:</span> app<span class="token punctuation">.</span>info<span class="token punctuation">;</span>
            app<span class="token punctuation">.</span>compat <span class="token operator">=</span> <span class="token function">compatibilityInfoForPackage</span><span class="token punctuation">(</span>appInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">ProfilerInfo</span> profilerInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> preBindAgent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mProfileData<span class="token punctuation">.</span><span class="token function">getProfileApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
                    <span class="token operator">&amp;&amp;</span> mProfileData<span class="token punctuation">.</span><span class="token function">getProfileApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 不进入</span>
                mProfileData<span class="token punctuation">.</span><span class="token function">setProfileProc</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mProfileData<span class="token punctuation">.</span><span class="token function">getProfilerInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Send a profiler info object to the app if either a file is given, or</span>
                    <span class="token comment">// an agent should be loaded at bind-time.</span>
                    <span class="token keyword">boolean</span> needsInfo <span class="token operator">=</span> mProfileData<span class="token punctuation">.</span><span class="token function">getProfilerInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>profileFile <span class="token operator">!=</span> <span class="token keyword">null</span>
                            <span class="token operator">||</span> mProfileData<span class="token punctuation">.</span><span class="token function">getProfilerInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>attachAgentDuringBind<span class="token punctuation">;</span>
                    profilerInfo <span class="token operator">=</span> needsInfo
                            <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">ProfilerInfo</span><span class="token punctuation">(</span>mProfileData<span class="token punctuation">.</span><span class="token function">getProfilerInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mProfileData<span class="token punctuation">.</span><span class="token function">getProfilerInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        preBindAgent <span class="token operator">=</span> mProfileData<span class="token punctuation">.</span><span class="token function">getProfilerInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agent<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>instr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> instr<span class="token punctuation">.</span>mProfileFile <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 不进入</span>
                profilerInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProfilerInfo</span><span class="token punctuation">(</span>instr<span class="token punctuation">.</span>mProfileFile<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mAppAgentMap <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mAppAgentMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 不进入</span>
                <span class="token comment">// We need to do a debuggable check here. See setAgentApp for why the check is</span>
                <span class="token comment">// postponed to here.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">ApplicationInfo</span><span class="token punctuation">.</span><span class="token constant">FLAG_DEBUGGABLE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> agent <span class="token operator">=</span> mAppAgentMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// Do not overwrite already requested agent.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>profilerInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        profilerInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProfilerInfo</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                mAppAgentMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>processName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>profilerInfo<span class="token punctuation">.</span>agent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        profilerInfo <span class="token operator">=</span> profilerInfo<span class="token punctuation">.</span><span class="token function">setAgent</span><span class="token punctuation">(</span>mAppAgentMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>processName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>profilerInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> profilerInfo<span class="token punctuation">.</span>profileFd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 不进入</span>
                profilerInfo<span class="token punctuation">.</span>profileFd <span class="token operator">=</span> profilerInfo<span class="token punctuation">.</span>profileFd<span class="token punctuation">.</span><span class="token function">dup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mProfileData<span class="token punctuation">.</span><span class="token function">getProfileApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> processName<span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> mProfileData<span class="token punctuation">.</span><span class="token function">getProfilerInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">clearProfilerLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// We deprecated Build.SERIAL and it is not accessible to</span>
            <span class="token comment">// Instant Apps and target APIs higher than O MR1. Since access to the serial</span>
            <span class="token comment">// is now behind a permission we push down the value.</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> buildSerial <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span>appInfo<span class="token punctuation">.</span><span class="token function">isInstantApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> appInfo<span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&lt;</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>P</span><span class="token punctuation">)</span>
                            <span class="token operator">?</span> sTheRealBuildSerial <span class="token operator">:</span> <span class="token class-name">Build</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">;</span>

            <span class="token comment">// Check if this is a secondary process that should be incorporated into some</span>
            <span class="token comment">// currently active instrumentation.  (Note we do this AFTER all of the profiling</span>
            <span class="token comment">// stuff above because profiling can currently happen only in the primary</span>
            <span class="token comment">// instrumentation process.)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mActiveInstrumentation<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> instr <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 不进入</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mActiveInstrumentation<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        i <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span><span class="token function">getActiveInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ActiveInstrumentation</span> aInstr <span class="token operator">=</span> mActiveInstrumentation<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>aInstr<span class="token punctuation">.</span>mFinished <span class="token operator">&amp;&amp;</span> aInstr<span class="token punctuation">.</span>mTargetInfo<span class="token punctuation">.</span>uid <span class="token operator">==</span> app<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>aInstr<span class="token punctuation">.</span>mTargetProcesses<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// This is the wildcard mode, where every process brought up for</span>
                            <span class="token comment">// the target instrumentation should be included.</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>aInstr<span class="token punctuation">.</span>mTargetInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                app<span class="token punctuation">.</span><span class="token function">setActiveInstrumentation</span><span class="token punctuation">(</span>aInstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                aInstr<span class="token punctuation">.</span>mRunningProcesses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> proc <span class="token operator">:</span> aInstr<span class="token punctuation">.</span>mTargetProcesses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    app<span class="token punctuation">.</span><span class="token function">setActiveInstrumentation</span><span class="token punctuation">(</span>aInstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    aInstr<span class="token punctuation">.</span>mRunningProcesses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// If we were asked to attach an agent on startup, do so now, before we're binding</span>
            <span class="token comment">// application code.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>preBindAgent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 不进入</span>
                thread<span class="token punctuation">.</span><span class="token function">attachAgent</span><span class="token punctuation">(</span>preBindAgent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>


            <span class="token comment">// Figure out whether the app needs to run in autofill compat mode.</span>
            <span class="token class-name">AutofillOptions</span> autofillOptions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token constant">FIRST_APPLICATION_UID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 进入</span>
                <span class="token keyword">final</span> <span class="token class-name">AutofillManagerInternal</span> afm <span class="token operator">=</span> <span class="token class-name">LocalServices</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>
                        <span class="token class-name">AutofillManagerInternal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>afm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    autofillOptions <span class="token operator">=</span> afm<span class="token punctuation">.</span><span class="token function">getAutofillOptions</span><span class="token punctuation">(</span>
                            app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>longVersionCode<span class="token punctuation">,</span> app<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">ContentCaptureOptions</span> contentCaptureOptions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token constant">FIRST_APPLICATION_UID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">ContentCaptureManagerInternal</span> ccm <span class="token operator">=</span>
                        <span class="token class-name">LocalServices</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">ContentCaptureManagerInternal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ccm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    contentCaptureOptions <span class="token operator">=</span> ccm<span class="token punctuation">.</span><span class="token function">getOptionsForPackage</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
                            app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">&quot;attachApplicationLocked: immediately before bindApplication&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bindApplicationTimeMillis <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mAtmInternal<span class="token punctuation">.</span><span class="token function">preBindApplication</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">ActiveInstrumentation</span> instr2 <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">getActiveInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>isolatedEntryPoint <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// This is an isolated process which should just call an entry point instead of</span>
                <span class="token comment">// being bound to an application.</span>
                thread<span class="token punctuation">.</span><span class="token function">runIsolatedEntryPoint</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>isolatedEntryPoint<span class="token punctuation">,</span> app<span class="token punctuation">.</span>isolatedEntryPointArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>instr2 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                thread<span class="token punctuation">.</span><span class="token function">bindApplication</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span> providers<span class="token punctuation">,</span>
                        instr2<span class="token punctuation">.</span>mClass<span class="token punctuation">,</span>
                        profilerInfo<span class="token punctuation">,</span> instr2<span class="token punctuation">.</span>mArguments<span class="token punctuation">,</span>
                        instr2<span class="token punctuation">.</span>mWatcher<span class="token punctuation">,</span>
                        instr2<span class="token punctuation">.</span>mUiAutomationConnection<span class="token punctuation">,</span> testMode<span class="token punctuation">,</span>
                        mBinderTransactionTrackingEnabled<span class="token punctuation">,</span> enableTrackAllocation<span class="token punctuation">,</span>
                        isRestrictedBackupMode <span class="token operator">||</span> <span class="token operator">!</span>normalMode<span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">isPersistent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        app<span class="token punctuation">.</span>compat<span class="token punctuation">,</span> <span class="token function">getCommonServicesLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>isolated<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        mCoreSettingsObserver<span class="token punctuation">.</span><span class="token function">getCoreSettingsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        buildSerial<span class="token punctuation">,</span> autofillOptions<span class="token punctuation">,</span> contentCaptureOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 走这里</span>
                thread<span class="token punctuation">.</span><span class="token function">bindApplication</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span> providers<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span>
                        <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> testMode<span class="token punctuation">,</span>
                        mBinderTransactionTrackingEnabled<span class="token punctuation">,</span> enableTrackAllocation<span class="token punctuation">,</span>
                        isRestrictedBackupMode <span class="token operator">||</span> <span class="token operator">!</span>normalMode<span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">isPersistent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        app<span class="token punctuation">.</span>compat<span class="token punctuation">,</span> <span class="token function">getCommonServicesLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>isolated<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        mCoreSettingsObserver<span class="token punctuation">.</span><span class="token function">getCoreSettingsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        buildSerial<span class="token punctuation">,</span> autofillOptions<span class="token punctuation">,</span> contentCaptureOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>profilerInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                profilerInfo<span class="token punctuation">.</span><span class="token function">closeFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                profilerInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 将目标 Activity 进程的 IApplicationThread 匿名 Binder 代理端绑定到 ProcessRecord 对象</span>
            <span class="token comment">// Make app active after binding application or client may be running requests (e.g</span>
            <span class="token comment">// starting activities) before it is ready.</span>
            app<span class="token punctuation">.</span><span class="token function">makeActive</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">&quot;attachApplicationLocked: immediately after bindApplication&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mProcessList<span class="token punctuation">.</span><span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">&quot;attachApplicationLocked: after updateLruProcessLocked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span>lastRequestedGc <span class="token operator">=</span> app<span class="token punctuation">.</span>lastLowMemory <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// todo: Yikes!  What should we do?  For now we will try to</span>
            <span class="token comment">// start another process, but that could easily get us in</span>
            <span class="token comment">// an infinite loop of restarting processes...</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Exception thrown during bind of &quot;</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

            app<span class="token punctuation">.</span><span class="token function">resetPackageList</span><span class="token punctuation">(</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">unlinkDeathRecipient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mProcessList<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HostingRecord</span><span class="token punctuation">(</span><span class="token string">&quot;bind-fail&quot;</span><span class="token punctuation">,</span> processName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Remove this record from the list of starting applications.</span>
        mPersistentStartingProcesses<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_PROCESSES</span> <span class="token operator">&amp;&amp;</span> mProcessesOnHold<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_PROCESSES</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Attach application locked removing on hold: &quot;</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mProcessesOnHold<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> badApp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> didSomething <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token comment">// See if the top visible activity is waiting to run in this process...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>normalMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 启动 Activity</span>
                didSomething <span class="token operator">=</span> mAtmInternal<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Exception thrown launching activities in &quot;</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                badApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Find any services that should be running in this process...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>badApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                didSomething <span class="token operator">|=</span> mServices<span class="token punctuation">.</span><span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">&quot;attachApplicationLocked: after mServices.attachApplicationLocked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Exception thrown starting services in &quot;</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                badApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Check if a next-broadcast receiver is in this process...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>badApp <span class="token operator">&amp;&amp;</span> <span class="token function">isPendingBroadcastProcessLocked</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                didSomething <span class="token operator">|=</span> <span class="token function">sendPendingBroadcastsLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">&quot;attachApplicationLocked: after sendPendingBroadcastsLocked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// If the app died trying to launch the receiver we declare it 'bad'</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Exception thrown dispatching broadcasts in &quot;</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                badApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Check whether the next backup agent is in this process...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>badApp <span class="token operator">&amp;&amp;</span> backupTarget <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> backupTarget<span class="token punctuation">.</span>app <span class="token operator">==</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_BACKUP</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_BACKUP</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;New app is backup target, launching agent for &quot;</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">notifyPackageUse</span><span class="token punctuation">(</span>backupTarget<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                             <span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">NOTIFY_PACKAGE_USE_BACKUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                thread<span class="token punctuation">.</span><span class="token function">scheduleCreateBackupAgent</span><span class="token punctuation">(</span>backupTarget<span class="token punctuation">.</span>appInfo<span class="token punctuation">,</span>
                        <span class="token function">compatibilityInfoForPackage</span><span class="token punctuation">(</span>backupTarget<span class="token punctuation">.</span>appInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        backupTarget<span class="token punctuation">.</span>backupMode<span class="token punctuation">,</span> backupTarget<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Exception thrown creating backup agent in &quot;</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                badApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>·                                                          ·       
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>badApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            app<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token string">&quot;error during init&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">handleAppDiedLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didSomething<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token class-name">OomAdjuster</span><span class="token punctuation">.</span><span class="token constant">OOM_ADJ_REASON_PROCESS_BEGIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">&quot;attachApplicationLocked: after updateOomAdjLocked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">StatsLog</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>
                <span class="token class-name">StatsLog</span><span class="token punctuation">.</span><span class="token constant">PROCESS_START_TIME</span><span class="token punctuation">,</span>
                app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
                app<span class="token punctuation">.</span>pid<span class="token punctuation">,</span>
                app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                <span class="token class-name">StatsLog</span><span class="token punctuation">.</span><span class="token constant">PROCESS_START_TIME__TYPE__COLD</span><span class="token punctuation">,</span>
                app<span class="token punctuation">.</span>startTime<span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>bindApplicationTimeMillis <span class="token operator">-</span> app<span class="token punctuation">.</span>startTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> app<span class="token punctuation">.</span>startTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
                app<span class="token punctuation">.</span>hostingRecord<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>app<span class="token punctuation">.</span>hostingRecord<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> app<span class="token punctuation">.</span>hostingRecord<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br></div></div><p>接着调用 App 端的 bindApplication：</p> <p>App 这边：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// ActivityThread.java</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bindApplication</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span> <span class="token class-name">ApplicationInfo</span> appInfo<span class="token punctuation">,</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProviderInfo</span><span class="token punctuation">&gt;</span></span> providers<span class="token punctuation">,</span> <span class="token class-name">ComponentName</span> instrumentationName<span class="token punctuation">,</span>
                <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> instrumentationArgs<span class="token punctuation">,</span>
                <span class="token class-name">IInstrumentationWatcher</span> instrumentationWatcher<span class="token punctuation">,</span>
                <span class="token class-name">IUiAutomationConnection</span> instrumentationUiConnection<span class="token punctuation">,</span> <span class="token keyword">int</span> debugMode<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> enableBinderTracking<span class="token punctuation">,</span> <span class="token keyword">boolean</span> trackAllocation<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> isRestrictedBackupMode<span class="token punctuation">,</span> <span class="token keyword">boolean</span> persistent<span class="token punctuation">,</span> <span class="token class-name">Configuration</span> config<span class="token punctuation">,</span>
                <span class="token class-name">CompatibilityInfo</span> compatInfo<span class="token punctuation">,</span> <span class="token class-name">Map</span> services<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> coreSettings<span class="token punctuation">,</span>
                <span class="token class-name">String</span> buildSerial<span class="token punctuation">,</span> <span class="token class-name">AutofillOptions</span> autofillOptions<span class="token punctuation">,</span>
                <span class="token class-name">ContentCaptureOptions</span> contentCaptureOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>services <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Test code to make sure the app could see the passed-in services.</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> oname <span class="token operator">:</span> services<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>services<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>oname<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// AM just passed in a null service.</span>
                        <span class="token punctuation">}</span>
                        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> oname<span class="token punctuation">;</span>

                        <span class="token comment">// See b/79378449 about the following exemption.</span>
                        <span class="token keyword">switch</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">case</span> <span class="token string">&quot;package&quot;</span><span class="token operator">:</span>
                            <span class="token keyword">case</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">WINDOW_SERVICE</span><span class="token operator">:</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Service &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; should be accessible by this app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 缓存操作</span>
                <span class="token comment">// Setup the service cache in the ServiceManager</span>
                <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">initServiceCache</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">setCoreSettings</span><span class="token punctuation">(</span>coreSettings<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 将 AMS 传递过来的参数封装到 AppBindData 数据结构中</span>
            <span class="token class-name">AppBindData</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppBindData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>processName <span class="token operator">=</span> processName<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>appInfo <span class="token operator">=</span> appInfo<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>providers <span class="token operator">=</span> providers<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>instrumentationName <span class="token operator">=</span> instrumentationName<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>instrumentationArgs <span class="token operator">=</span> instrumentationArgs<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>instrumentationWatcher <span class="token operator">=</span> instrumentationWatcher<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>instrumentationUiAutomationConnection <span class="token operator">=</span> instrumentationUiConnection<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>debugMode <span class="token operator">=</span> debugMode<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>enableBinderTracking <span class="token operator">=</span> enableBinderTracking<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>trackAllocation <span class="token operator">=</span> trackAllocation<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>restrictedBackupMode <span class="token operator">=</span> isRestrictedBackupMode<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>persistent <span class="token operator">=</span> persistent<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>compatInfo <span class="token operator">=</span> compatInfo<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>initProfilerInfo <span class="token operator">=</span> profilerInfo<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>buildSerial <span class="token operator">=</span> buildSerial<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>autofillOptions <span class="token operator">=</span> autofillOptions<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>contentCaptureOptions <span class="token operator">=</span> contentCaptureOptions<span class="token punctuation">;</span>
            <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">.</span><span class="token constant">BIND_APPLICATION</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>向主线程 Looper 发一个 message，处理函数：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// ActivityThread.java</span>
    <span class="token keyword">class</span> <span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_MESSAGES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;&gt;&gt;&gt; handling: &quot;</span> <span class="token operator">+</span> <span class="token function">codeToString</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// ......</span>
                <span class="token keyword">case</span> <span class="token constant">BIND_APPLICATION</span><span class="token operator">:</span>
                    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;bindApplication&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">AppBindData</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AppBindData</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                    <span class="token function">handleBindApplication</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleBindApplication</span><span class="token punctuation">(</span><span class="token class-name">AppBindData</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Register the UI Thread as a sensitive thread to the runtime.</span>
        <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token function">registerSensitiveThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// In the case the stack depth property exists, pass it down to the runtime.</span>
        <span class="token class-name">String</span> property <span class="token operator">=</span> <span class="token class-name">SystemProperties</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;debug.allocTracker.stackDepth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>property<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">VMDebug</span><span class="token punctuation">.</span><span class="token function">setAllocTrackerStackDepth</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>trackAllocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DdmVmInternal</span><span class="token punctuation">.</span><span class="token function">enableRecentAllocations</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Note when this process has started.</span>
        <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">setStartTimes</span><span class="token punctuation">(</span><span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mBoundApplication <span class="token operator">=</span> data<span class="token punctuation">;</span>
        mConfiguration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCompatConfiguration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mProfiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Profiler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> agent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>initProfilerInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mProfiler<span class="token punctuation">.</span>profileFile <span class="token operator">=</span> data<span class="token punctuation">.</span>initProfilerInfo<span class="token punctuation">.</span>profileFile<span class="token punctuation">;</span>
            mProfiler<span class="token punctuation">.</span>profileFd <span class="token operator">=</span> data<span class="token punctuation">.</span>initProfilerInfo<span class="token punctuation">.</span>profileFd<span class="token punctuation">;</span>
            mProfiler<span class="token punctuation">.</span>samplingInterval <span class="token operator">=</span> data<span class="token punctuation">.</span>initProfilerInfo<span class="token punctuation">.</span>samplingInterval<span class="token punctuation">;</span>
            mProfiler<span class="token punctuation">.</span>autoStopProfiler <span class="token operator">=</span> data<span class="token punctuation">.</span>initProfilerInfo<span class="token punctuation">.</span>autoStopProfiler<span class="token punctuation">;</span>
            mProfiler<span class="token punctuation">.</span>streamingOutput <span class="token operator">=</span> data<span class="token punctuation">.</span>initProfilerInfo<span class="token punctuation">.</span>streamingOutput<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>initProfilerInfo<span class="token punctuation">.</span>attachAgentDuringBind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                agent <span class="token operator">=</span> data<span class="token punctuation">.</span>initProfilerInfo<span class="token punctuation">.</span>agent<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// send up app name; do this *before* waiting for debugger</span>
        <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">setArgV0</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>ddm<span class="token punctuation">.</span></span>DdmHandleAppName</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>processName<span class="token punctuation">,</span>
                                                <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token function">setProcessPackageName</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Pass data directory path to ART. This is used for caching information and</span>
        <span class="token comment">// should be set before any application code is loaded.</span>
        <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token function">setProcessDataDirectory</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>dataDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mProfiler<span class="token punctuation">.</span>profileFd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mProfiler<span class="token punctuation">.</span><span class="token function">startProfiling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If the app is Honeycomb MR1 or earlier, switch its AsyncTask</span>
        <span class="token comment">// implementation to use the pool executor.  Normally, we use the</span>
        <span class="token comment">// serialized executor as the default. This has to happen in the</span>
        <span class="token comment">// main thread so the main looper is set right.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&lt;=</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Build</span><span class="token punctuation">.</span><span class="token constant">VERSION_CODES</span><span class="token punctuation">.</span><span class="token constant">HONEYCOMB_MR1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AsyncTask</span><span class="token punctuation">.</span><span class="token function">setDefaultExecutor</span><span class="token punctuation">(</span><span class="token class-name">AsyncTask</span><span class="token punctuation">.</span><span class="token constant">THREAD_POOL_EXECUTOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Let the util.*Array classes maintain &quot;undefined&quot; for apps targeting Pie or earlier.</span>
        <span class="token class-name">UtilConfig</span><span class="token punctuation">.</span><span class="token function">setThrowExceptionForUpperArrayOutOfBounds</span><span class="token punctuation">(</span>
                data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&gt;=</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>Q</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">updateCheckRecycle</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Prior to P, internal calls to decode Bitmaps used BitmapFactory,</span>
        <span class="token comment">// which may scale up to account for density. In P, we switched to</span>
        <span class="token comment">// ImageDecoder, which skips the upscale to save memory. ImageDecoder</span>
        <span class="token comment">// needs to still scale up in older apps, in case they rely on the</span>
        <span class="token comment">// size of the Bitmap without considering its density.</span>
        <span class="token class-name">ImageDecoder</span><span class="token punctuation">.</span>sApiLevel <span class="token operator">=</span> data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">;</span>

        <span class="token comment">/*
         * Before spawning a new process, reset the time zone to be the system time zone.
         * This needs to be done because the system time zone could have changed after the
         * the spawning of this process. Without doing this this process would have the incorrect
         * system time zone.
         */</span>
        <span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">setDefault</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * Set the LocaleList. This may change once we create the App Context.
         */</span>
        <span class="token class-name">LocaleList</span><span class="token punctuation">.</span><span class="token function">setDefault</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">getLocales</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*
             * Update the system configuration since its preloaded and might not
             * reflect configuration changes. The configuration object passed
             * in AppBindData can be safely assumed to be up to date
             */</span>
            mResourcesManager<span class="token punctuation">.</span><span class="token function">applyConfigurationToResourcesLocked</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>config<span class="token punctuation">,</span> data<span class="token punctuation">.</span>compatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mCurDefaultDisplayDpi <span class="token operator">=</span> data<span class="token punctuation">.</span>config<span class="token punctuation">.</span>densityDpi<span class="token punctuation">;</span>

            <span class="token comment">// This calls mResourcesManager so keep it within the synchronized block.</span>
            <span class="token function">applyCompatConfiguration</span><span class="token punctuation">(</span>mCurDefaultDisplayDpi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 创建 LoadedApk 对象,此处是关键，后续会专门分析</span>
        data<span class="token punctuation">.</span>info <span class="token operator">=</span> <span class="token function">getPackageInfoNoCheck</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">,</span> data<span class="token punctuation">.</span>compatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>agent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">handleAttachAgent</span><span class="token punctuation">(</span>agent<span class="token punctuation">,</span> data<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">// Android 应用默认 dpi 相关设置</span>
        <span class="token comment">/**
         * Switch this process to density compatibility mode if needed.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span><span class="token class-name">ApplicationInfo</span><span class="token punctuation">.</span><span class="token constant">FLAG_SUPPORTS_SCREEN_DENSITIES</span><span class="token punctuation">)</span>
                <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mDensityCompatMode <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token class-name">Bitmap</span><span class="token punctuation">.</span><span class="token function">setDefaultDensity</span><span class="token punctuation">(</span><span class="token class-name">DisplayMetrics</span><span class="token punctuation">.</span><span class="token constant">DENSITY_DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">updateDefaultDensity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">String</span> use24HourSetting <span class="token operator">=</span> mCoreSettings<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token class-name">Settings<span class="token punctuation">.</span>System</span><span class="token punctuation">.</span><span class="token constant">TIME_12_24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> is24Hr <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>use24HourSetting <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            is24Hr <span class="token operator">=</span> <span class="token string">&quot;24&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>use24HourSetting<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span> <span class="token operator">:</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// null : use locale default for 12/24 hour formatting,</span>
        <span class="token comment">// false : use 12 hour format,</span>
        <span class="token comment">// true : use 24 hour format.</span>
        <span class="token class-name">DateFormat</span><span class="token punctuation">.</span><span class="token function">set24HourTimePref</span><span class="token punctuation">(</span>is24Hr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">updateDebugViewAttributeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">initThreadDefaults</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">initVmDefaults</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>debugMode <span class="token operator">!=</span> <span class="token class-name">ApplicationThreadConstants</span><span class="token punctuation">.</span><span class="token constant">DEBUG_OFF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// XXX should have option to change the port.</span>
            <span class="token class-name">Debug</span><span class="token punctuation">.</span><span class="token function">changeDebugPort</span><span class="token punctuation">(</span><span class="token number">8100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>debugMode <span class="token operator">==</span> <span class="token class-name">ApplicationThreadConstants</span><span class="token punctuation">.</span><span class="token constant">DEBUG_WAIT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Application &quot;</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                      <span class="token operator">+</span> <span class="token string">&quot; is waiting for the debugger on port 8100...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">IActivityManager</span> mgr <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    mgr<span class="token punctuation">.</span><span class="token function">showWaitingForDebugger</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">Debug</span><span class="token punctuation">.</span><span class="token function">waitForDebugger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    mgr<span class="token punctuation">.</span><span class="token function">showWaitingForDebugger</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Application &quot;</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                      <span class="token operator">+</span> <span class="token string">&quot; can be debugged on port 8100...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Allow binder tracing, and application-generated systrace messages if we're profileable.</span>
        <span class="token keyword">boolean</span> isAppProfileable <span class="token operator">=</span> data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span><span class="token function">isProfileableByShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">setAppTracingAllowed</span><span class="token punctuation">(</span>isAppProfileable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isAppProfileable <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>enableBinderTracking<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">enableTracing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Initialize heap profiling.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isAppProfileable <span class="token operator">||</span> <span class="token class-name">Build</span><span class="token punctuation">.</span><span class="token constant">IS_DEBUGGABLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">nInitZygoteChildHeapProfiling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Allow renderer debugging features if we're debuggable.</span>
        <span class="token keyword">boolean</span> isAppDebuggable <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">ApplicationInfo</span><span class="token punctuation">.</span><span class="token constant">FLAG_DEBUGGABLE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">HardwareRenderer</span><span class="token punctuation">.</span><span class="token function">setDebuggingEnabled</span><span class="token punctuation">(</span>isAppDebuggable <span class="token operator">||</span> <span class="token class-name">Build</span><span class="token punctuation">.</span><span class="token constant">IS_DEBUGGABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HardwareRenderer</span><span class="token punctuation">.</span><span class="token function">setPackageName</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * Initialize the default http proxy in this process for the reasons we set the time zone.
         */</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;Setup proxies&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">IBinder</span> b <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">CONNECTIVITY_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// In pre-boot mode (doing initial launch to collect password), not</span>
            <span class="token comment">// all system is up.  This includes the connectivity service, so don't</span>
            <span class="token comment">// crash if we can't get it.</span>
            <span class="token keyword">final</span> <span class="token class-name">IConnectivityManager</span> service <span class="token operator">=</span> <span class="token class-name">IConnectivityManager<span class="token punctuation">.</span>Stub</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">setHttpProxySystemProperty</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getProxyForNetwork</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Instrumentation info affects the class loader, so load it before</span>
        <span class="token comment">// setting up the app context.</span>
        <span class="token keyword">final</span> <span class="token class-name">InstrumentationInfo</span> ii<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                ii <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationPackageManager</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">getInstrumentationInfo</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManager<span class="token punctuation">.</span>NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Unable to find instrumentation info for: &quot;</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>instrumentationName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Warn of potential ABI mismatches.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>primaryCpuAbi<span class="token punctuation">,</span> ii<span class="token punctuation">.</span>primaryCpuAbi<span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>secondaryCpuAbi<span class="token punctuation">,</span> ii<span class="token punctuation">.</span>secondaryCpuAbi<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Package uses different ABI(s) than its instrumentation: &quot;</span>
                        <span class="token operator">+</span> <span class="token string">&quot;package[&quot;</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName <span class="token operator">+</span> <span class="token string">&quot;]: &quot;</span>
                        <span class="token operator">+</span> data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>primaryCpuAbi <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>secondaryCpuAbi
                        <span class="token operator">+</span> <span class="token string">&quot; instrumentation[&quot;</span> <span class="token operator">+</span> ii<span class="token punctuation">.</span>packageName <span class="token operator">+</span> <span class="token string">&quot;]: &quot;</span>
                        <span class="token operator">+</span> ii<span class="token punctuation">.</span>primaryCpuAbi <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> ii<span class="token punctuation">.</span>secondaryCpuAbi<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mInstrumentationPackageName <span class="token operator">=</span> ii<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
            mInstrumentationAppDir <span class="token operator">=</span> ii<span class="token punctuation">.</span>sourceDir<span class="token punctuation">;</span>
            mInstrumentationSplitAppDirs <span class="token operator">=</span> ii<span class="token punctuation">.</span>splitSourceDirs<span class="token punctuation">;</span>
            mInstrumentationLibDir <span class="token operator">=</span> <span class="token function">getInstrumentationLibrary</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">,</span> ii<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInstrumentedAppDir <span class="token operator">=</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">getAppDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInstrumentedSplitAppDirs <span class="token operator">=</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">getSplitAppDirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInstrumentedLibDir <span class="token operator">=</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">getLibDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ii <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token class-name">ContextImpl</span> appContext <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateLocaleListFromAppContext</span><span class="token punctuation">(</span>appContext<span class="token punctuation">,</span>
                mResourcesManager<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocales</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">isIsolated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> oldMask <span class="token operator">=</span> <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">allowThreadDiskWritesMask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">setupGraphicsSupport</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">setThreadPolicyMask</span><span class="token punctuation">(</span>oldMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">HardwareRenderer</span><span class="token punctuation">.</span><span class="token function">setIsolatedProcess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Install the Network Security Config Provider. This must happen before the application</span>
        <span class="token comment">// code is loaded to prevent issues with instances of TLS objects being created before</span>
        <span class="token comment">// the provider is installed.</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;NetworkSecurityConfigProvider.install&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">NetworkSecurityConfigProvider</span><span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Continue loading instrumentation.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ii <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ApplicationInfo</span> instrApp<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                instrApp <span class="token operator">=</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>ii<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                        <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                instrApp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>instrApp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                instrApp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ii<span class="token punctuation">.</span><span class="token function">copyTo</span><span class="token punctuation">(</span>instrApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            instrApp<span class="token punctuation">.</span><span class="token function">initForUser</span><span class="token punctuation">(</span><span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">LoadedApk</span> pi <span class="token operator">=</span> <span class="token function">getPackageInfo</span><span class="token punctuation">(</span>instrApp<span class="token punctuation">,</span> data<span class="token punctuation">.</span>compatInfo<span class="token punctuation">,</span>
                    appContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// The test context's op package name == the target app's op package name, because</span>
            <span class="token comment">// the app ops manager checks the op package name against the real calling UID,</span>
            <span class="token comment">// which is what the target package name is associated with.</span>
            <span class="token keyword">final</span> <span class="token class-name">ContextImpl</span> instrContext <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> pi<span class="token punctuation">,</span>
                    appContext<span class="token punctuation">.</span><span class="token function">getOpPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>

                <span class="token comment">// 创建 Instrumentation</span>
                <span class="token keyword">final</span> <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> instrContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mInstrumentation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Instrumentation</span><span class="token punctuation">)</span>
                    cl<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationName<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Unable to instantiate instrumentation &quot;</span>
                    <span class="token operator">+</span> data<span class="token punctuation">.</span>instrumentationName <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> <span class="token class-name">ComponentName</span> component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>ii<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> ii<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mInstrume <span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Debug</span><span class="token punctuation">.</span><span class="token function">startMethodTracing</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mInstrumentation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInstrumentation<span class="token punctuation">.</span><span class="token function">basicInit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span><span class="token class-name">ApplicationInfo</span><span class="token punctuation">.</span><span class="token constant">FLAG_LARGE_HEAP</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token namespace">dalvik<span class="token punctuation">.</span>system<span class="token punctuation">.</span></span>VMRuntime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clearGrowthLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Small heap, clamp to the current growth limit and let the heap release</span>
            <span class="token comment">// pages after the growth limit to the non growth limit capacity. b/18387825</span>
            <span class="token class-name"><span class="token namespace">dalvik<span class="token punctuation">.</span>system<span class="token punctuation">.</span></span>VMRuntime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clampGrowthLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Allow disk access during application and provider setup. This could</span>
        <span class="token comment">// block processing ordered broadcasts, but later processing would</span>
        <span class="token comment">// probably end up doing the same disk access.</span>
        <span class="token class-name">Application</span> app<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">StrictMode<span class="token punctuation">.</span>ThreadPolicy</span> savedPolicy <span class="token operator">=</span> <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">allowThreadDiskWrites</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">StrictMode<span class="token punctuation">.</span>ThreadPolicy</span> writesAllowedPolicy <span class="token operator">=</span> <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">getThreadPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// If the app is being launched for full backup or restore, bring it up in</span>
            <span class="token comment">// a restricted environment with the base application class.</span>
            app <span class="token operator">=</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>restrictedBackupMode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Propagate autofill compat state</span>
            app<span class="token punctuation">.</span><span class="token function">setAutofillOptions</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>autofillOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Propagate Content Capture options</span>
            app<span class="token punctuation">.</span><span class="token function">setContentCaptureOptions</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>contentCaptureOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mInitialApplication <span class="token operator">=</span> app<span class="token punctuation">;</span>

            <span class="token comment">// don't bring up providers in restricted mode; they may depend on the</span>
            <span class="token comment">// app's custom Application class</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>restrictedBackupMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ArrayUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>providers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 安装 ContentProvider，这个留在后面 ContentProvider 的章节来讲</span>
                    <span class="token function">installContentProviders</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> data<span class="token punctuation">.</span>providers<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Do this after providers, since instrumentation tests generally start their</span>
            <span class="token comment">// test thread at this point, and we don't want that racing.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//执行 Instrumentation onCreate 方法</span>
                mInstrumentation<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Exception thrown in onCreate() of &quot;</span>
                    <span class="token operator">+</span> data<span class="token punctuation">.</span>instrumentationName <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mInstrumentation<span class="token punctuation">.</span><span class="token function">callApplicationOnCreate</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                      <span class="token string">&quot;Unable to create application &quot;</span> <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                      <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// If the app targets &lt; O-MR1, or doesn't change the thread policy</span>
            <span class="token comment">// during startup, clobber the policy to maintain behavior of b/36951662</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&lt;</span> <span class="token class-name">Build</span><span class="token punctuation">.</span><span class="token constant">VERSION_CODES</span><span class="token punctuation">.</span><span class="token constant">O_MR1</span>
                    <span class="token operator">||</span> <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">getThreadPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>writesAllowedPolicy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">setThreadPolicy</span><span class="token punctuation">(</span>savedPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Preload fonts resources</span>
        <span class="token class-name">FontsContract</span><span class="token punctuation">.</span><span class="token function">setApplicationContextForResources</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">isIsolated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">ApplicationInfo</span> info <span class="token operator">=</span>
                        <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>
                                data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                                <span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">GET_META_DATA</span> <span class="token comment">/*flags*/</span><span class="token punctuation">,</span>
                                <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>metaData <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> preloadedFontsResource <span class="token operator">=</span> info<span class="token punctuation">.</span>metaData<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
                            <span class="token class-name">ApplicationInfo</span><span class="token punctuation">.</span><span class="token constant">METADATA_PRELOADED_FONTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>preloadedFontsResource <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preloadFonts</span><span class="token punctuation">(</span>preloadedFontsResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br></div></div><p>回到 AMS 这边，接着执行 <code>didSomething = mAtmInternal.attachApplication(app.getWindowProcessController());</code> 进入到 ATMS 这边</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>        <span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span><span class="token class-name">WindowProcessController</span> wpc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mGlobalLockWithoutBoost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> mRootActivityContainer<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>wpc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/RootActivityContainer.java</span>
    <span class="token keyword">boolean</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span><span class="token class-name">WindowProcessController</span> app<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> processName <span class="token operator">=</span> app<span class="token punctuation">.</span>mName<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> didSomething <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> displayNdx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">ActivityDisplay</span> display <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>displayNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> stack <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getFocusedStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stack <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stack<span class="token punctuation">.</span><span class="token function">getAllRunningVisibleActivitiesLocked</span><span class="token punctuation">(</span>mTmpActivityList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 目标 ActivityRecord</span>
                <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> top <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> mTmpActivityList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> activity <span class="token operator">=</span> mTmpActivityList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>activity<span class="token punctuation">.</span>app <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>mUid <span class="token operator">==</span> activity<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid
                            <span class="token operator">&amp;&amp;</span> processName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>mStackSupervisor<span class="token punctuation">.</span><span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> app<span class="token punctuation">,</span>
                                    top <span class="token operator">==</span> activity <span class="token comment">/* andResume */</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* checkConfig */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                didSomething <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Exception in new application when starting activity &quot;</span>
                                    <span class="token operator">+</span> top<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didSomething<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ensureActivitiesVisible</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* preserve_windows */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> didSomething<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityStackSupervisor.java  </span>
    <span class="token keyword">boolean</span> <span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">WindowProcessController</span> proc<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> andResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mRootActivityContainer<span class="token punctuation">.</span><span class="token function">allPausedActivitiesComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// While there are activities pausing we skipping starting any new activities until</span>
            <span class="token comment">// pauses are complete. NOTE: that we also do this for activities that are starting in</span>
            <span class="token comment">// the paused state because they will first be resumed then paused on the client side.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_SWITCH</span> <span class="token operator">||</span> <span class="token constant">DEBUG_PAUSE</span> <span class="token operator">||</span> <span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_PAUSE</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;realStartActivityLocked: Skipping start of r=&quot;</span> <span class="token operator">+</span> r
                    <span class="token operator">+</span> <span class="token string">&quot; some activities pausing...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token class-name">TaskRecord</span> task <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getTaskRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> stack <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">beginDeferResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">startFreezingScreenLocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// schedule launch ticks to collect information about slow apps.</span>
            r<span class="token punctuation">.</span><span class="token function">startLaunchTickingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            r<span class="token punctuation">.</span><span class="token function">setProcess</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Ensure activity is allowed to be resumed after process has set.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>andResume <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">canResumeByCompat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                andResume <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getKeyguardController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isKeyguardLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span><span class="token function">notifyUnknownVisibilityLaunched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Have the window manager re-evaluate the orientation of the screen based on the new</span>
            <span class="token comment">// activity order.  Note that as a result of this, it can call back into the activity</span>
            <span class="token comment">// manager with a new orientation.  We don't care about that, because the activity is</span>
            <span class="token comment">// not currently running so we are just restarting it anyway.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>checkConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Deferring resume here because we're going to launch new activity shortly.</span>
                <span class="token comment">// We don't want to perform a redundant launch of the same record while ensuring</span>
                <span class="token comment">// configurations and trying to resume top activity of focused stack.</span>
                mRootActivityContainer<span class="token punctuation">.</span><span class="token function">ensureVisibilityAndConfig</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token boolean">false</span> <span class="token comment">/* markFrozenIfConfigChanged */</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* deferResume */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getActivityStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkKeyguardVisibility</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* shouldBeVisible */</span><span class="token punctuation">,</span>
                    <span class="token boolean">true</span> <span class="token comment">/* isTop */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// We only set the visibility to true if the activity is allowed to be visible</span>
                <span class="token comment">// based on</span>
                <span class="token comment">// keyguard state. This avoids setting this into motion in window manager that is</span>
                <span class="token comment">// later cancelled due to later calls to ensure visible activities that set</span>
                <span class="token comment">// visibility back to false.</span>
                r<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> <span class="token keyword">int</span> applicationInfoUid <span class="token operator">=</span>
                    <span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>mUserId <span class="token operator">!=</span> proc<span class="token punctuation">.</span>mUserId<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>uid <span class="token operator">!=</span> applicationInfoUid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;User ID for activity changing for &quot;</span> <span class="token operator">+</span> r
                                <span class="token operator">+</span> <span class="token string">&quot; appInfo.uid=&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>uid
                                <span class="token operator">+</span> <span class="token string">&quot; info.ai.uid=&quot;</span> <span class="token operator">+</span> applicationInfoUid
                                <span class="token operator">+</span> <span class="token string">&quot; old=&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>app <span class="token operator">+</span> <span class="token string">&quot; new=&quot;</span> <span class="token operator">+</span> proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            r<span class="token punctuation">.</span>launchCount<span class="token operator">++</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>lastLaunchTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_ALL</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Launching: &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>

            proc<span class="token punctuation">.</span><span class="token function">addActivityIfNeeded</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token class-name">LockTaskController</span> lockTaskController <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getLockTaskController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>mLockTaskAuth <span class="token operator">==</span> <span class="token constant">LOCK_TASK_AUTH_LAUNCHABLE</span>
                    <span class="token operator">||</span> task<span class="token punctuation">.</span>mLockTaskAuth <span class="token operator">==</span> <span class="token constant">LOCK_TASK_AUTH_LAUNCHABLE_PRIV</span>
                    <span class="token operator">||</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>mLockTaskAuth <span class="token operator">==</span> <span class="token constant">LOCK_TASK_AUTH_WHITELISTED</span>
                            <span class="token operator">&amp;&amp;</span> lockTaskController<span class="token punctuation">.</span><span class="token function">getLockTaskModeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token operator">==</span> <span class="token constant">LOCK_TASK_MODE_LOCKED</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lockTaskController<span class="token punctuation">.</span><span class="token function">startLockTaskMode</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* blank UID */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>proc<span class="token punctuation">.</span><span class="token function">hasThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemoteException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResultInfo</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReferrerIntent</span><span class="token punctuation">&gt;</span></span> newIntents <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>andResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// We don't need to deliver new intents and/or set results if activity is going</span>
                    <span class="token comment">// to pause immediately after launch.</span>
                    results <span class="token operator">=</span> r<span class="token punctuation">.</span>results<span class="token punctuation">;</span>
                    newIntents <span class="token operator">=</span> r<span class="token punctuation">.</span>newIntents<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_SWITCH</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_SWITCH</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;Launching: &quot;</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">&quot; icicle=&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>icicle <span class="token operator">+</span> <span class="token string">&quot; with results=&quot;</span> <span class="token operator">+</span> results
                                <span class="token operator">+</span> <span class="token string">&quot; newIntents=&quot;</span> <span class="token operator">+</span> newIntents <span class="token operator">+</span> <span class="token string">&quot; andResume=&quot;</span> <span class="token operator">+</span> andResume<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">EventLog</span><span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span><span class="token constant">AM_RESTART_ACTIVITY</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>mUserId<span class="token punctuation">,</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span>taskId<span class="token punctuation">,</span> r<span class="token punctuation">.</span>shortComponentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isActivityTypeHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Home process is the root process of the task.</span>
                    <span class="token function">updateHomeProcess</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>mActivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mService<span class="token punctuation">.</span><span class="token function">getPackageManagerInternalLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notifyPackageUse</span><span class="token punctuation">(</span>
                        r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NOTIFY_PACKAGE_USE_ACTIVITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>sleeping <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>forceNewConfig <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                mService<span class="token punctuation">.</span><span class="token function">getAppWarningsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onStartActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>compat <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">compatibilityInfoForPackageLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Because we could be starting an Activity in the system process this may not go</span>
                <span class="token comment">// across a Binder interface which would create a new Configuration. Consequently</span>
                <span class="token comment">// we have to always create a new Configuration here.</span>

                <span class="token keyword">final</span> <span class="token class-name">MergedConfiguration</span> mergedConfiguration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MergedConfiguration</span><span class="token punctuation">(</span>
                        proc<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">getMergedOverrideConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span><span class="token function">setLastReportedConfiguration</span><span class="token punctuation">(</span>mergedConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">logIfTransactionTooLarge</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>icicle<span class="token punctuation">)</span><span class="token punctuation">;</span>


                <span class="token comment">// Create activity launch transaction.</span>
                <span class="token keyword">final</span> <span class="token class-name">ClientTransaction</span> clientTransaction <span class="token operator">=</span> <span class="token class-name">ClientTransaction</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>
                        proc<span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>appToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token class-name">DisplayContent</span> dc <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mDisplayContent<span class="token punctuation">;</span>
                <span class="token comment">// 注意这里添加了 Callback</span>
                <span class="token comment">// LaunchActivityItem</span>
                clientTransaction<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token class-name">LaunchActivityItem</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">,</span>
                        <span class="token comment">// TODO: Have this take the merged configuration instead of separate global</span>
                        <span class="token comment">// and override configs.</span>
                        mergedConfiguration<span class="token punctuation">.</span><span class="token function">getGlobalConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        mergedConfiguration<span class="token punctuation">.</span><span class="token function">getOverrideConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>compat<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">,</span> task<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> proc<span class="token punctuation">.</span><span class="token function">getReportedProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>icicle<span class="token punctuation">,</span> r<span class="token punctuation">.</span>persistentState<span class="token punctuation">,</span> results<span class="token punctuation">,</span> newIntents<span class="token punctuation">,</span>
                        dc<span class="token punctuation">.</span><span class="token function">isNextTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proc<span class="token punctuation">.</span><span class="token function">createProfilerInfoIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                r<span class="token punctuation">.</span>assistToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Set desired final state.</span>
                <span class="token keyword">final</span> <span class="token class-name">ActivityLifecycleItem</span> lifecycleItem<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>andResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 走这里</span>
                    <span class="token comment">// ResumeActivityItem</span>
                    lifecycleItem <span class="token operator">=</span> <span class="token class-name">ResumeActivityItem</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>dc<span class="token punctuation">.</span><span class="token function">isNextTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    lifecycleItem <span class="token operator">=</span> <span class="token class-name">PauseActivityItem</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                clientTransaction<span class="token punctuation">.</span><span class="token function">setLifecycleStateRequest</span><span class="token punctuation">(</span>lifecycleItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token comment">// 远程调用 App，执行生命周期</span>
                <span class="token comment">// Schedule transaction.</span>
                mService<span class="token punctuation">.</span><span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>clientTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>proc<span class="token punctuation">.</span>mInfo<span class="token punctuation">.</span>privateFlags <span class="token operator">&amp;</span> <span class="token class-name">ApplicationInfo</span><span class="token punctuation">.</span><span class="token constant">PRIVATE_FLAG_CANT_SAVE_STATE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                        <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span>mHasHeavyWeightFeature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// This may be a heavy-weight process! Note that the package manager will ensure</span>
                    <span class="token comment">// that only activity can run in the main process of the .apk, which is the only</span>
                    <span class="token comment">// thing that will be considered heavy-weight.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>mName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>proc<span class="token punctuation">.</span>mInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mHeavyWeightProcess <span class="token operator">!=</span> <span class="token keyword">null</span>
                                <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span>mHeavyWeightProcess <span class="token operator">!=</span> proc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Starting new heavy weight process &quot;</span> <span class="token operator">+</span> proc
                                    <span class="token operator">+</span> <span class="token string">&quot; when already running &quot;</span>
                                    <span class="token operator">+</span> mService<span class="token punctuation">.</span>mHeavyWeightProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        mService<span class="token punctuation">.</span><span class="token function">setHeavyWeightProcess</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>launchFailed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// This is the second time we failed -- finish activity and give up.</span>
                    <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Second failure launching &quot;</span>
                            <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, giving up&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    proc<span class="token punctuation">.</span><span class="token function">appDied</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    stack<span class="token punctuation">.</span><span class="token function">requestFinishActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token constant">RESULT_CANCELED</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                            <span class="token string">&quot;2nd-crash&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// This is the first time we failed -- restart process and</span>
                <span class="token comment">// retry.</span>
                r<span class="token punctuation">.</span>launchFailed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                proc<span class="token punctuation">.</span><span class="token function">removeActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">endDeferResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        r<span class="token punctuation">.</span>launchFailed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token punctuation">.</span><span class="token function">updateLRUListLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Activity &quot;</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">&quot; being launched, but already in LRU list&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// TODO(lifecycler): Resume or pause requests are done as part of launch transaction,</span>
        <span class="token comment">// so updating the state should be done accordingly.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>andResume <span class="token operator">&amp;&amp;</span> <span class="token function">readyToResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// As part of the process of launching, ActivityThread also performs</span>
            <span class="token comment">// a resume.</span>
            <span class="token comment">/*
            	此时目标Activity已经调用完onResume()方法了，
            	所以这时候需要将目标Activity所属的ActivityStack栈中的mResumedActivity
            	设置目标Activity，并且状态置为RESUMED
            */</span>
            stack<span class="token punctuation">.</span><span class="token function">minimalResumeActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// This activity is not starting in the resumed state... which should look like we asked</span>
            <span class="token comment">// it to pause+stop (but remain visible), and it has done so and reported back the</span>
            <span class="token comment">// current icicle and other state.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_STATES</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;Moving to PAUSED: &quot;</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">&quot; (starting in paused state)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token constant">PAUSED</span><span class="token punctuation">,</span> <span class="token string">&quot;realStartActivityLocked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Perform OOM scoring after the activity state is set, so the process can be updated with</span>
        <span class="token comment">// the latest state.</span>
        proc<span class="token punctuation">.</span><span class="token function">onStartActivity</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mTopProcessState<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Launch the new version setup screen if needed.  We do this -after-</span>
        <span class="token comment">// launching the initial activity (that is, home), so that it can have</span>
        <span class="token comment">// a chance to initialize itself while in the background, making the</span>
        <span class="token comment">// switch back to it faster and look better.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRootActivityContainer<span class="token punctuation">.</span><span class="token function">isTopDisplayFocusedStack</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span><span class="token function">getActivityStartController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startSetupActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Update any services we are bound to that might care about whether</span>
        <span class="token comment">// their client may have activities.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">updateServiceConnectionActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>      
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br></div></div><p>接着调用 <code>mService.getLifecycleManager().scheduleTransaction</code> 向 App 端发起 Binder RPC 调用：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ClientLifecycleManager</span> mLifecycleManager<span class="token punctuation">;</span>

    <span class="token class-name">ClientLifecycleManager</span> <span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mLifecycleManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// /frameworks/base/core/java/android/app/servertransaction/ClientTransaction.java</span>
    <span class="token comment">/**
     * Schedule a single lifecycle request or callback to client activity.
     * @param client Target client.
     * @param activityToken Target activity token.
     * @param stateRequest A request to move target activity to a desired lifecycle state.
     * @throws RemoteException
     *
     * @see ClientTransactionItem
     */</span>
    <span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IApplicationThread</span> client<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IBinder</span> activityToken<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ActivityLifecycleItem</span> stateRequest<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">ClientTransaction</span> clientTransaction <span class="token operator">=</span> <span class="token function">transactionWithState</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> activityToken<span class="token punctuation">,</span>
                stateRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>clientTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>接着调用重载 scheduleTransaction：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// /frameworks/base/core/java/android/app/servertransaction/ClientTransaction.java</span>
    <span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">IApplicationThread</span> client <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关注点</span>
        transaction<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>client <span class="token keyword">instanceof</span> <span class="token class-name">Binder</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If client is not an instance of Binder - it's a remote call and at this point it is</span>
            <span class="token comment">// safe to recycle the object. All objects used for local calls will be recycled after</span>
            <span class="token comment">// the transaction is executed on client in ActivityThread.</span>
            transaction<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>    

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>接着调用 schedule：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
 <span class="token comment">// /frameworks/base/core/java/android/app/servertransaction/ClientTransaction.java</span>
    <span class="token comment">/** Target client. */</span>
    <span class="token keyword">private</span> <span class="token class-name">IApplicationThread</span> mClient<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Schedule the transaction after it was initialized. It will be send to client and all its
     * individual parts will be applied in the following sequence:
     * 1. The client calls {@link #preExecute(ClientTransactionHandler)}, which triggers all work
     *    that needs to be done before actually scheduling the transaction for callbacks and
     *    lifecycle state request.
     * 2. The transaction message is scheduled.
     * 3. The client calls {@link TransactionExecutor#execute(ClientTransaction)}, which executes
     *    all callbacks and necessary lifecycle transitions.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
        mClient<span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>层层调用到 IApplicationThread 的 scheduleTransaction 方法，这是一个 Binder RPC 调用：</p> <p>远程调用 App 端的 scheduleTransaction 方法。</p> <p>远程调用到 Activity 端：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// /frameworks/base/core/java/android/app/ActivityThread.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ActivityThread</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** Prepare and schedule transaction for execution. */</span>
<span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    transaction<span class="token punctuation">.</span><span class="token function">preExecute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">ActivityThread<span class="token punctuation">.</span>H</span><span class="token punctuation">.</span><span class="token constant">EXECUTE_TRANSACTION</span><span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这里会发送一个 Message，ActivityThread 中的 Handler 中会处理到这个 Message：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// /frameworks/base/core/java/android/app/ActivityThread.java</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token constant">EXECUTE_TRANSACTION</span><span class="token operator">:</span>
                    <span class="token comment">// 从 Message 中取出消息</span>
                    <span class="token keyword">final</span> <span class="token class-name">ClientTransaction</span> transaction <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                    <span class="token comment">// 执行消息</span>
                    mTransactionExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Client transactions inside system process are recycled on the client side</span>
                        <span class="token comment">// instead of ClientLifecycleManager to avoid being cleared before this</span>
                        <span class="token comment">// message is handled.</span>
                        transaction<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// TODO(lifecycler): Recycle locally scheduled transactions.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>            
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>从 Message 中取出消息</li> <li>执行消息</li></ul> <p>接着我们来看执行消息的过程：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
    <span class="token comment">// /frameworks/base/core/java/android/app/servertransaction/TransactionExecutor.java</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_RESOLVER</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token function">tId</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;Start resolving transaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ......</span>

        <span class="token comment">// 执行回调</span>
        <span class="token comment">// </span>
        <span class="token function">executeCallbacks</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 执行生命周期</span>
        <span class="token comment">// ResumeActivityItem</span>
        <span class="token function">executeLifecycleState</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPendingActions<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_RESOLVER</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token function">tId</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;End resolving transaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>先看 <code>executeCallbacks</code> 执行回调：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// /frameworks/base/core/java/android/app/servertransaction/TransactionExecutor.java</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeCallbacks</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 拿到 callback</span>
        <span class="token comment">// 返回的就是 ATMS 中设置的 LaunchActivityItem</span>
        <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientTransactionItem</span><span class="token punctuation">&gt;</span></span> callbacks <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callbacks <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> callbacks<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// No callbacks to execute, return early.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_RESOLVER</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token function">tId</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;Resolving callbacks in transaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">IBinder</span> token <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getActivityToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ActivityClientRecord</span> r <span class="token operator">=</span> mTransactionHandler<span class="token punctuation">.</span><span class="token function">getActivityClient</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// In case when post-execution state of the last callback matches the final state requested</span>
        <span class="token comment">// for the activity in this transaction, we won't do the last transition here and do it when</span>
        <span class="token comment">// moving to final state instead (because it may contain additional parameters from server).</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityLifecycleItem</span> finalStateRequest <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getLifecycleStateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> finalState <span class="token operator">=</span> finalStateRequest <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> finalStateRequest<span class="token punctuation">.</span><span class="token function">getTargetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">:</span> <span class="token constant">UNDEFINED</span><span class="token punctuation">;</span>
        <span class="token comment">// Index of the last callback that requests some post-execution state.</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> lastCallbackRequestingState <span class="token operator">=</span> <span class="token function">lastCallbackRequestingState</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 遍历 callbacks</span>
            <span class="token keyword">final</span> <span class="token class-name">ClientTransactionItem</span> item <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_RESOLVER</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token function">tId</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;Resolving callback: &quot;</span> <span class="token operator">+</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> postExecutionState <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getPostExecutionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> closestPreExecutionState <span class="token operator">=</span> mHelper<span class="token punctuation">.</span><span class="token function">getClosestPreExecutionState</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>
                    item<span class="token punctuation">.</span><span class="token function">getPostExecutionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closestPreExecutionState <span class="token operator">!=</span> <span class="token constant">UNDEFINED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">cycleToPath</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> closestPreExecutionState<span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 依次执行 LaunchActivityItem 的 execute 和 postExecute 方法</span>
            item<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>mTransactionHandler<span class="token punctuation">,</span> token<span class="token punctuation">,</span> mPendingActions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            item<span class="token punctuation">.</span><span class="token function">postExecute</span><span class="token punctuation">(</span>mTransactionHandler<span class="token punctuation">,</span> token<span class="token punctuation">,</span> mPendingActions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Launch activity request will create an activity record.</span>
                r <span class="token operator">=</span> mTransactionHandler<span class="token punctuation">.</span><span class="token function">getActivityClient</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>postExecutionState <span class="token operator">!=</span> <span class="token constant">UNDEFINED</span> <span class="token operator">&amp;&amp;</span> r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Skip the very last transition and perform it by explicit state request instead.</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> shouldExcludeLastTransition <span class="token operator">=</span>
                        i <span class="token operator">==</span> lastCallbackRequestingState <span class="token operator">&amp;&amp;</span> finalState <span class="token operator">==</span> postExecutionState<span class="token punctuation">;</span>
                <span class="token function">cycleToPath</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> postExecutionState<span class="token punctuation">,</span> shouldExcludeLastTransition<span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>接着看 <code>LaunchActivityItem</code> 的 execute 和 postExecute 方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// </span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransactionHandler</span> client<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span>
            <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;activityStart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构建好 ActivityClientRecord 对象，客户端这边描述 Activity 的对象</span>
        <span class="token class-name">ActivityClientRecord</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityClientRecord</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> mIntent<span class="token punctuation">,</span> mIdent<span class="token punctuation">,</span> mInfo<span class="token punctuation">,</span>
                mOverrideConfig<span class="token punctuation">,</span> mCompatInfo<span class="token punctuation">,</span> mReferrer<span class="token punctuation">,</span> mVoiceInteractor<span class="token punctuation">,</span> mState<span class="token punctuation">,</span> mPersistentState<span class="token punctuation">,</span>
                mPendingResults<span class="token punctuation">,</span> mPendingNewIntents<span class="token punctuation">,</span> mIsForward<span class="token punctuation">,</span>
                mProfilerInfo<span class="token punctuation">,</span> client<span class="token punctuation">,</span> mAssistToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> pendingActions<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* customIntent */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postExecute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransactionHandler</span> client<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span>
            <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">countLaunchingActivities</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>接着执行 ActivityThread 的 handleLaunchActivity 和 countLaunchingActivities 方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// frameworks/base/core/java/android/app/ActivityThread.java</span>

    <span class="token comment">/**
     * Extended implementation of activity launch. Used when server requests a launch or relaunch.
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Activity</span> <span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span>
            <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">,</span> <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If we are getting ready to gc after going to the background, well</span>
        <span class="token comment">// we are back active so skip it.</span>
        <span class="token function">unscheduleGcIdler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSomeActivitiesChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>profilerInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mProfiler<span class="token punctuation">.</span><span class="token function">setProfiler</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>profilerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mProfiler<span class="token punctuation">.</span><span class="token function">startProfiling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Make sure we are running with the most recent config.</span>
        <span class="token function">handleConfigurationChanged</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>
            <span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Handling launch of &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Initialize before creating the activity</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ThreadedRenderer</span><span class="token punctuation">.</span>sRendererDisabled
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span><span class="token constant">FLAG_HARDWARE_ACCELERATED</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">HardwareRenderer</span><span class="token punctuation">.</span><span class="token function">preload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">WindowManagerGlobal</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Hint the GraphicsEnvironment that an activity is launching on the process.</span>
        <span class="token class-name">GraphicsEnvironment</span><span class="token punctuation">.</span><span class="token function">hintActivityLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 接着调用 performLaunchActivity</span>
        <span class="token keyword">final</span> <span class="token class-name">Activity</span> a <span class="token operator">=</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> customIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>createdConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>mConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">reportSizeConfigurations</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished <span class="token operator">&amp;&amp;</span> pendingActions <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pendingActions<span class="token punctuation">.</span><span class="token function">setOldState</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pendingActions<span class="token punctuation">.</span><span class="token function">setRestoreInstanceState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pendingActions<span class="token punctuation">.</span><span class="token function">setCallOnPostCreate</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// If there was an error, for any reason, tell the activity manager to stop us.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">ActivityTaskManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">finishActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>token<span class="token punctuation">,</span> <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token constant">RESULT_CANCELED</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                                <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token constant">DONT_FINISH_TASK_WITH_ACTIVITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 记录一个数据， 这里传的 -1</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">countLaunchingActivities</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mNumLaunchingActivities<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p>接着看 <code>performLaunchActivity</code> 的实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// frameworks/base/core/java/android/app/ActivityThread.java</span>

    <span class="token comment">/**  Core implementation of activity launch. */</span>
    <span class="token keyword">private</span> <span class="token class-name">Activity</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ActivityInfo</span> aInfo <span class="token operator">=</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>packageInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>packageInfo <span class="token operator">=</span> <span class="token function">getPackageInfo</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> r<span class="token punctuation">.</span>compatInfo<span class="token punctuation">,</span>
                    <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">CONTEXT_INCLUDE_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ComponentName</span> component <span class="token operator">=</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>component <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            component <span class="token operator">=</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">resolveActivity</span><span class="token punctuation">(</span>
                mInitialApplication<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>targetActivity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>targetActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ContextImpl</span> appContext <span class="token operator">=</span> <span class="token function">createBaseContextForActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Activity</span> activity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span> cl <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 反射创建一个 Activity 对象</span>
            activity <span class="token operator">=</span> mInstrumentation<span class="token punctuation">.</span><span class="token function">newActivity</span><span class="token punctuation">(</span>
                    cl<span class="token punctuation">,</span> component<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">incrementExpectedActivityCount</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">setClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Unable to instantiate activity &quot;</span> <span class="token operator">+</span> component
                    <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Application</span> app <span class="token operator">=</span> r<span class="token punctuation">.</span>packageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> mInstrumentation<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Performing launch of &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>
                    <span class="token constant">TAG</span><span class="token punctuation">,</span> r <span class="token operator">+</span> <span class="token string">&quot;: app=&quot;</span> <span class="token operator">+</span> app
                    <span class="token operator">+</span> <span class="token string">&quot;, appName=&quot;</span> <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;, pkg=&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>packageInfo<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;, comp=&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;, dir=&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>packageInfo<span class="token punctuation">.</span><span class="token function">getAppDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">CharSequence</span> title <span class="token operator">=</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span><span class="token function">loadLabel</span><span class="token punctuation">(</span>appContext<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// new 一个 configuration</span>
                <span class="token class-name">Configuration</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>mCompatConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>overrideConfig <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    config<span class="token punctuation">.</span><span class="token function">updateFrom</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>overrideConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_CONFIGURATION</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Launching activity &quot;</span>
                        <span class="token operator">+</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot; with config &quot;</span> <span class="token operator">+</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Window</span> window <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>mPendingRemoveWindow <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>mPreserveWindow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    window <span class="token operator">=</span> r<span class="token punctuation">.</span>mPendingRemoveWindow<span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>mPendingRemoveWindow <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>mPendingRemoveWindowManager <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                appContext<span class="token punctuation">.</span><span class="token function">setOuterContext</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// attach 重点</span>
                activity<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>appContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>token<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>ident<span class="token punctuation">,</span> app<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">,</span> title<span class="token punctuation">,</span> r<span class="token punctuation">.</span>parent<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>embeddedID<span class="token punctuation">,</span> r<span class="token punctuation">.</span>lastNonConfigurationInstances<span class="token punctuation">,</span> config<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span> r<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> window<span class="token punctuation">,</span> r<span class="token punctuation">.</span>configCallback<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>assistToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>customIntent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    activity<span class="token punctuation">.</span>mIntent <span class="token operator">=</span> customIntent<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                r<span class="token punctuation">.</span>lastNonConfigurationInstances <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token function">checkAndBlockForNetworkAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                activity<span class="token punctuation">.</span>mStartedActivity <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> theme <span class="token operator">=</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span><span class="token function">getThemeResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>theme <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    activity<span class="token punctuation">.</span><span class="token function">setTheme</span><span class="token punctuation">(</span>theme<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                activity<span class="token punctuation">.</span>mCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

                <span class="token comment">// 走 else</span>
                <span class="token comment">//persistableMode 查看  https://blog.csdn.net/lincyang/article/details/45287599</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isPersistable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">,</span> r<span class="token punctuation">.</span>persistentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activity<span class="token punctuation">.</span>mCalled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SuperNotCalledException</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Activity &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                        <span class="token string">&quot; did not call through to super.onCreate()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                r<span class="token punctuation">.</span>activity <span class="token operator">=</span> activity<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token constant">ON_CREATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// updatePendingActivityConfiguration() reads from mActivities to update</span>
            <span class="token comment">// ActivityClientRecord which runs in a different thread. Protect modifications to</span>
            <span class="token comment">// mActivities to avoid race.</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mActivities<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>token<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SuperNotCalledException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Unable to start activity &quot;</span> <span class="token operator">+</span> component
                    <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> activity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br></div></div><p>重点调用 Activity 的 attach 方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// frameworks/base/core/java/android/app/Activity.java</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ActivityThread</span> aThread<span class="token punctuation">,</span>
            <span class="token class-name">Instrumentation</span> instr<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token keyword">int</span> ident<span class="token punctuation">,</span>
            <span class="token class-name">Application</span> application<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">ActivityInfo</span> info<span class="token punctuation">,</span>
            <span class="token class-name">CharSequence</span> title<span class="token punctuation">,</span> <span class="token class-name">Activity</span> parent<span class="token punctuation">,</span> <span class="token class-name">String</span> id<span class="token punctuation">,</span>
            <span class="token class-name">NonConfigurationInstances</span> lastNonConfigurationInstances<span class="token punctuation">,</span>
            <span class="token class-name">Configuration</span> config<span class="token punctuation">,</span> <span class="token class-name">String</span> referrer<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
            <span class="token class-name">Window</span> window<span class="token punctuation">,</span> <span class="token class-name">ActivityConfigCallback</span> activityConfigCallback<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> assistToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">attachBaseContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mFragments<span class="token punctuation">.</span><span class="token function">attachHost</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/*parent*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 初始化 PhoneWindow 对象 </span>
        mWindow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhoneWindow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> window<span class="token punctuation">,</span> activityConfigCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWindow<span class="token punctuation">.</span><span class="token function">setWindowControllerCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWindow<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWindow<span class="token punctuation">.</span><span class="token function">setOnWindowDismissedCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWindow<span class="token punctuation">.</span><span class="token function">getLayoutInflater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPrivateFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>softInputMode <span class="token operator">!=</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">SOFT_INPUT_STATE_UNSPECIFIED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mWindow<span class="token punctuation">.</span><span class="token function">setSoftInputMode</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>softInputMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>uiOptions <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mWindow<span class="token punctuation">.</span><span class="token function">setUiOptions</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>uiOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 初始化 Activity 的成员变量</span>
        mUiThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mMainThread <span class="token operator">=</span> aThread<span class="token punctuation">;</span>
        mInstrumentation <span class="token operator">=</span> instr<span class="token punctuation">;</span>
        mToken <span class="token operator">=</span> token<span class="token punctuation">;</span>
        mAssistToken <span class="token operator">=</span> assistToken<span class="token punctuation">;</span>
        mIdent <span class="token operator">=</span> ident<span class="token punctuation">;</span>
        mApplication <span class="token operator">=</span> application<span class="token punctuation">;</span>
        mIntent <span class="token operator">=</span> intent<span class="token punctuation">;</span>
        mReferrer <span class="token operator">=</span> referrer<span class="token punctuation">;</span>
        mComponent <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mActivityInfo <span class="token operator">=</span> info<span class="token punctuation">;</span>
        mTitle <span class="token operator">=</span> title<span class="token punctuation">;</span>
        mParent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
        mEmbeddedID <span class="token operator">=</span> id<span class="token punctuation">;</span>
        mLastNonConfigurationInstances <span class="token operator">=</span> lastNonConfigurationInstances<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voiceInteractor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastNonConfigurationInstances <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mVoiceInteractor <span class="token operator">=</span> lastNonConfigurationInstances<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mVoiceInteractor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoiceInteractor</span><span class="token punctuation">(</span>voiceInteractor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 给 PhoneWindow 设置 WindowManager</span>
        mWindow<span class="token punctuation">.</span><span class="token function">setWindowManager</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span><span class="token class-name">WindowManager</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">WINDOW_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                mToken<span class="token punctuation">,</span> mComponent<span class="token punctuation">.</span><span class="token function">flattenToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span><span class="token constant">FLAG_HARDWARE_ACCELERATED</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mParent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mWindow<span class="token punctuation">.</span><span class="token function">setContainer</span><span class="token punctuation">(</span>mParent<span class="token punctuation">.</span><span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mWindowManager <span class="token operator">=</span> mWindow<span class="token punctuation">.</span><span class="token function">getWindowManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCurrentConfig <span class="token operator">=</span> config<span class="token punctuation">;</span>

        mWindow<span class="token punctuation">.</span><span class="token function">setColorMode</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>colorMode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setAutofillOptions</span><span class="token punctuation">(</span>application<span class="token punctuation">.</span><span class="token function">getAutofillOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentCaptureOptions</span><span class="token punctuation">(</span>application<span class="token punctuation">.</span><span class="token function">getContentCaptureOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>接着调用 <code>executeLifecycleState</code> 来执行生命周期：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// /frameworks/base/core/java/android/app/servertransaction/TransactionExecutor.java</span>
        <span class="token comment">/** Transition to the final state if requested by the transaction. */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">executeLifecycleState</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 拿到 ActivityLifecycleItem，这里是子类 ResumeActivityItem</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityLifecycleItem</span> lifecycleItem <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getLifecycleStateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// ......</span>

        <span class="token comment">// token 是一个索引值</span>
        <span class="token comment">// 通过 token 可以拿到 ActivityClientRecord，这个对象是 App 端的，用于描述描述一个 Activity</span>
        <span class="token keyword">final</span> <span class="token class-name">IBinder</span> token <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getActivityToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityClientRecord</span> r <span class="token operator">=</span> mTransactionHandler<span class="token punctuation">.</span><span class="token function">getActivityClient</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_RESOLVER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token function">tId</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;Resolving lifecycle state: &quot;</span>
                    <span class="token operator">+</span> lifecycleItem <span class="token operator">+</span> <span class="token string">&quot; for activity: &quot;</span>
                    <span class="token operator">+</span> <span class="token function">getShortActivityName</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> mTransactionHandler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Ignore requests for non-existent client records for now.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Cycle to the state right before the final requested state.</span>
        <span class="token function">cycleToPath</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> lifecycleItem<span class="token punctuation">.</span><span class="token function">getTargetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* excludeLastState */</span><span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Execute the final transition with proper parameters.</span>
        <span class="token comment">// 执行生命周期</span>
        lifecycleItem<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>mTransactionHandler<span class="token punctuation">,</span> token<span class="token punctuation">,</span> mPendingActions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行生命周期后的操作也要关心</span>
        lifecycleItem<span class="token punctuation">.</span><span class="token function">postExecute</span><span class="token punctuation">(</span>mTransactionHandler<span class="token punctuation">,</span> token<span class="token punctuation">,</span> mPendingActions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>接着执行 ResumeActivityIt 的 execute：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// /frameworks/base/core/java/android/app/servertransaction/ResumeActivityIt.java</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransactionHandler</span> client<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span>
            <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;activityResume&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">handleResumeActivity</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* finalStateRequest */</span><span class="token punctuation">,</span> mIsForward<span class="token punctuation">,</span>
                <span class="token string">&quot;RESUME_ACTIVITY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postExecute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransactionHandler</span> client<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span>
            <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// TODO(lifecycler): Use interface callback instead of AMS.</span>
            <span class="token comment">// 远程调用 ATMS 的 activityResumed</span>
            <span class="token class-name">ActivityTaskManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activityResumed</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>client 的具体类型是 ActivityThread
接着执行到 ActivityThread 的 handleResumeActivity 方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// /frameworks/base/core/java/android/app/ActivityThread.java</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleResumeActivity</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finalStateRequest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isForward<span class="token punctuation">,</span>
            <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If we are getting ready to gc after going to the background, well</span>
        <span class="token comment">// we are back active so skip it.</span>
        <span class="token function">unscheduleGcIdler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSomeActivitiesChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token comment">// 关键</span>
        <span class="token comment">// TODO Push resumeArgs into the activity for consideration</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityClientRecord</span> r <span class="token operator">=</span> <span class="token function">performResumeActivity</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> finalStateRequest<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// We didn't actually resume the activity, so skipping any follow-up actions.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mActivitiesToBeDestroyed<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Although the activity is resumed, it is going to be destroyed. So the following</span>
            <span class="token comment">// UI operations are unnecessary and also prevents exception because its token may</span>
            <span class="token comment">// be gone that window manager cannot recognize it. All necessary cleanup actions</span>
            <span class="token comment">// performed below will be done while handling destruction.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token class-name">Activity</span> a <span class="token operator">=</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Resume &quot;</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">&quot; started activity: &quot;</span> <span class="token operator">+</span> a<span class="token punctuation">.</span>mStartedActivity
                    <span class="token operator">+</span> <span class="token string">&quot;, hideForNow: &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>hideForNow <span class="token operator">+</span> <span class="token string">&quot;, finished: &quot;</span> <span class="token operator">+</span> a<span class="token punctuation">.</span>mFinished<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> forwardBit <span class="token operator">=</span> isForward
                <span class="token operator">?</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">SOFT_INPUT_IS_FORWARD_NAVIGATION</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// If the window hasn't yet been added to the window manager,</span>
        <span class="token comment">// and this guy didn't finish itself or start another activity,</span>
        <span class="token comment">// then go ahead and add the window.</span>
        <span class="token keyword">boolean</span> willBeVisible <span class="token operator">=</span> <span class="token operator">!</span>a<span class="token punctuation">.</span>mStartedActivity<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>willBeVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                willBeVisible <span class="token operator">=</span> <span class="token class-name">ActivityTaskManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">willActivityBeVisible</span><span class="token punctuation">(</span>
                        a<span class="token punctuation">.</span><span class="token function">getActivityToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>window <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>a<span class="token punctuation">.</span>mFinished <span class="token operator">&amp;&amp;</span> willBeVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>window <span class="token operator">=</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">View</span> decor <span class="token operator">=</span> r<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">getDecorView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            decor<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">.</span><span class="token constant">INVISIBLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ViewManager</span> wm <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">getWindowManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span> l <span class="token operator">=</span> r<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>mDecor <span class="token operator">=</span> decor<span class="token punctuation">;</span>
            l<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">TYPE_BASE_APPLICATION</span><span class="token punctuation">;</span>
            l<span class="token punctuation">.</span>softInputMode <span class="token operator">|=</span> forwardBit<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>mPreserveWindow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                a<span class="token punctuation">.</span>mWindowAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>mPreserveWindow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment">// Normally the ViewRoot sets up callbacks with the Activity</span>
                <span class="token comment">// in addView-&gt;ViewRootImpl#setView. If we are instead reusing</span>
                <span class="token comment">// the decor view we have to notify the view root that the</span>
                <span class="token comment">// callbacks may have changed.</span>
                <span class="token class-name">ViewRootImpl</span> impl <span class="token operator">=</span> decor<span class="token punctuation">.</span><span class="token function">getViewRootImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>impl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    impl<span class="token punctuation">.</span><span class="token function">notifyChildRebuilt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>mVisibleFromClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>a<span class="token punctuation">.</span>mWindowAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    a<span class="token punctuation">.</span>mWindowAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    wm<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>decor<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// The activity will get a callback for this {@link LayoutParams} change</span>
                    <span class="token comment">// earlier. However, at that time the decor will not be set (this is set</span>
                    <span class="token comment">// in this method), so no action will be taken. This call ensures the</span>
                    <span class="token comment">// callback occurs with the decor set.</span>
                    a<span class="token punctuation">.</span><span class="token function">onWindowAttributesChanged</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// If the window has already been added, but during resume</span>
            <span class="token comment">// we started another activity, then don't yet make the</span>
            <span class="token comment">// window visible.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>willBeVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Launch &quot;</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">&quot; mStartedActivity set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>hideForNow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Get rid of anything left hanging around.</span>
        <span class="token function">cleanUpPendingRemoveWindows</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* force */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// The window is now visible if it has been added, we are not</span>
        <span class="token comment">// simply finishing, and we are not starting another activity.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished <span class="token operator">&amp;&amp;</span> willBeVisible <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mDecor <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>hideForNow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>newConfig <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">performConfigurationChangedForActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>newConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_CONFIGURATION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Resuming activity &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot; with newConfig &quot;</span>
                            <span class="token operator">+</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mCurrentConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                r<span class="token punctuation">.</span>newConfig <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Resuming &quot;</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">&quot; with isForward=&quot;</span> <span class="token operator">+</span> isForward<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span> l <span class="token operator">=</span> r<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>softInputMode
                    <span class="token operator">&amp;</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span class="token punctuation">)</span>
                    <span class="token operator">!=</span> forwardBit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                l<span class="token punctuation">.</span>softInputMode <span class="token operator">=</span> <span class="token punctuation">(</span>l<span class="token punctuation">.</span>softInputMode
                        <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">|</span> forwardBit<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mVisibleFromClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ViewManager</span> wm <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">getWindowManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">View</span> decor <span class="token operator">=</span> r<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">getDecorView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    wm<span class="token punctuation">.</span><span class="token function">updateViewLayout</span><span class="token punctuation">(</span>decor<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mVisibleFromServer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mNumVisibleActivities<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mVisibleFromClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">makeVisible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        r<span class="token punctuation">.</span>nextIdle <span class="token operator">=</span> mNewActivities<span class="token punctuation">;</span>
        mNewActivities <span class="token operator">=</span> r<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Scheduling idle handler for &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIdleHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Idler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br></div></div><p>接着调用 performResumeActivity：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// /frameworks/base/core/java/android/app/ActivityThread.java</span>

    <span class="token comment">/**
     * Resume the activity.
     * @param token Target activity token.
     * @param finalStateRequest Flag indicating if this is part of final state resolution for a
     *                          transaction.
     * @param reason Reason for performing the action.
     *
     * @return The {@link ActivityClientRecord} that was resumed, {@code null} otherwise.
     */</span>
    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token keyword">public</span> <span class="token class-name">ActivityClientRecord</span> <span class="token function">performResumeActivity</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finalStateRequest<span class="token punctuation">,</span>
            <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityClientRecord</span> r <span class="token operator">=</span> mActivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Performing resume of &quot;</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">&quot; finished=&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getLifecycleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">ON_RESUME</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>finalStateRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">RuntimeException</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Trying to resume activity which is already resumed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">getStateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// TODO(lifecycler): A double resume request is possible when an activity</span>
                <span class="token comment">// receives two consequent transactions with relaunch requests and &quot;resumed&quot;</span>
                <span class="token comment">// final state requests and the second relaunch is omitted. We still try to</span>
                <span class="token comment">// handle two resume requests for the final state. For cases other than this</span>
                <span class="token comment">// one, we don't expect it to happen.</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>finalStateRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>hideForNow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mStartedActivity <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">onStateNotSaved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFragments<span class="token punctuation">.</span><span class="token function">noteStateNotSaved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkAndBlockForNetworkAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>pendingIntents <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">deliverNewIntents</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>pendingIntents<span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>pendingIntents <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>pendingResults <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">deliverResults</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>pendingResults<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>pendingResults <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 调用 Activity 的 performResume</span>
            r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">performResume</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>startsNotResumed<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

            r<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>persistentState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token constant">ON_RESUME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">reportTopResumedActivityChanged</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>isTopResumedActivity<span class="token punctuation">,</span> <span class="token string">&quot;topWhenResuming&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to resume activity &quot;</span>
                        <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>调用 Activity 的 performResume：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// /frameworks/base/core/java/android/app/ActivityThread.java</span>
        <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">performResume</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> followedByPause<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dispatchActivityPreResumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">performRestart</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment">/* start */</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mFragments<span class="token punctuation">.</span><span class="token function">execPendingActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mLastNonConfigurationInstances <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAutoFillResetNeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// When Activity is destroyed in paused state, and relaunch activity, there will be</span>
            <span class="token comment">// extra onResume and onPause event,  ignore the first onResume and onPause.</span>
            <span class="token comment">// see ActivityThread.handleRelaunchActivity()</span>
            mAutoFillIgnoreFirstResumePause <span class="token operator">=</span> followedByPause<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mAutoFillIgnoreFirstResumePause <span class="token operator">&amp;&amp;</span> <span class="token constant">DEBUG_LIFECYCLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;autofill will ignore first pause when relaunching &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// mResumed is set by the instrumentation</span>
        <span class="token comment">// 调用 Activity 的 onResume 生命周期回调方法</span>
        mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnResume</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">writeEventLog</span><span class="token punctuation">(</span><span class="token constant">LOG_AM_ON_RESUME_CALLED</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mCalled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SuperNotCalledException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Activity &quot;</span> <span class="token operator">+</span> mComponent<span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                <span class="token string">&quot; did not call through to super.onResume()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// invisible activities must be finished before onResume() completes</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mVisibleFromClient <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mFinished<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;An activity without a UI must call finish() before onResume() completes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>targetSdkVersion
                    <span class="token operator">&gt;</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Build</span><span class="token punctuation">.</span><span class="token constant">VERSION_CODES</span><span class="token punctuation">.</span><span class="token constant">LOLLIPOP_MR1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Activity &quot;</span> <span class="token operator">+</span> mComponent<span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                        <span class="token string">&quot; did not call finish() prior to onResume() completing&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Now really resume, and install the current status bar and menu.</span>
        mCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        mFragments<span class="token punctuation">.</span><span class="token function">dispatchResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mFragments<span class="token punctuation">.</span><span class="token function">execPendingActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">onPostResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mCalled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SuperNotCalledException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Activity &quot;</span> <span class="token operator">+</span> mComponent<span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                <span class="token string">&quot; did not call through to super.onPostResume()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">dispatchActivityPostResumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

        <span class="token comment">/**
     * Perform calling of an activity's {@link Activity#onResume} method.  The
     * default implementation simply calls through to that method.
     * 
     * @param activity The activity being resumed.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callActivityOnResume</span><span class="token punctuation">(</span><span class="token class-name">Activity</span> activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        activity<span class="token punctuation">.</span>mResumed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        activity<span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mActivityMonitors <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token class-name">N</span> <span class="token operator">=</span> mActivityMonitors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token class-name">N</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token class-name">ActivityMonitor</span> am <span class="token operator">=</span> mActivityMonitors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    am<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> activity<span class="token punctuation">,</span> activity<span class="token punctuation">.</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><p>最后在 postexcute 中会远程调用 ATMS 的 activityResumed 方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">activityResumed</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mGlobalLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ActivityRecord</span><span class="token punctuation">.</span><span class="token function">activityResumedLocked</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mWindowManager<span class="token punctuation">.</span><span class="token function">notifyAppResumedFinished</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <ul><li><a href="https://blog.csdn.net/tkwxty/article/details/109304542" target="_blank" rel="noopener noreferrer">Activity启动流程(六)注册目标Activity进程到system_server进程以及创建目标Activity进程Application<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:0;" data-v-b57cc07c data-v-7dd95ae2></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/AndroidFrameworkTutorialPages/assets/js/app.6bee58ca.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/7.4046385e.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/2.b8949bfe.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/1.1165d272.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/207.6a0fb53c.js" defer></script>
  </body>
</html>
